<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Smart Budget</title>

  <!-- PWA Manifest (Ÿäÿ™ŸàŸÑÿØ ÿØÿßÿÆŸÑ ÿßŸÑÿµŸÅÿ≠ÿ© ŸàŸäŸèÿ≥ÿ¨ŸëŸéŸÑ ÿ¢ŸÑŸäŸãÿß) -->
  <link id="manifestLink" rel="manifest">

  <meta name="theme-color" content="#0e2a44"/>

  <!-- OneSignal SDK -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

  <!-- Firebase (CDN) -->
  <script defer src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --bg:#f6f7f9;--card:#fff;--ink:#24364a;--muted:#6c7a89;
      --brand:#2c74ff;--sand:#e9e2d3;--sage:#cfe1d5;--blue:#d9e6ff;
      --ok:#1bbf74;--warn:#ffb200;--bad:#ff6b6b;--soft:#e9eef6;
      --shadow:0 10px 26px rgba(25,42,70,.07);
    }
    [data-theme="dark"]{
      --bg:#0f1720;--card:#111b27;--ink:#f5f7fb;--muted:#9fb0c2;
      --brand:#5ea1ff;--sand:#3b3a31;--sage:#2d3a33;--blue:#21314a;
      --soft:#1b2633;--shadow:0 10px 26px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;
      background:var(--bg);color:var(--ink)}
    .wrap{max-width:1100px;padding:18px;margin:0 auto}
    header{display:flex;align-items:center;gap:14px;flex-wrap:wrap}
    .logo{display:flex;align-items:center;gap:10px}
    .logo-badge{width:36px;height:36px;border-radius:12px;background:#0e2a44;
      display:grid;place-items:center;box-shadow:var(--shadow)}
    .logo-badge svg{width:22px;height:22px;fill:#f0c766}
    h1{margin:0;font-size:28px;letter-spacing:.3px}
    .toolbar{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
    .input,.btn,select{border:1px solid transparent;background:var(--card);
      color:var(--ink);border-radius:12px;padding:10px 14px;height:44px;
      box-shadow:var(--shadow)}
    .btn{background:#2c74ff;color:#fff;border:none;font-weight:600}
    .btn.ghost{background:var(--card);color:var(--ink)}
    .tabs{display:flex;gap:12px;flex-wrap:wrap;margin:18px 0}
    .tab{padding:10px 16px;border-radius:12px;background:var(--soft);color:var(--ink);
      cursor:pointer;border:1px solid transparent}
    .tab.active{background:#2c74ff;color:#fff}
    .card{background:var(--card);border-radius:16px;padding:18px;box-shadow:var(--shadow);margin:14px 0}
    .grid{display:grid;gap:12px}
    @media(min-width:820px){.grid-2{grid-template-columns:1fr 1fr}}
    .stat{display:flex;align-items:center;justify-content:space-between}
    .muted{color:var(--muted);font-size:14px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(140,150,170,.15)}
    th{text-align:left;color:var(--muted);font-weight:600}
    .pill{padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700}
    .ok{background:rgba(27,191,116,.12);color:#11a364}
    .warn{background:rgba(255,178,0,.16);color:#c58900}
    .bad{background:rgba(255,107,107,.16);color:#c84d4d}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .grow{flex:1}
    .hint{font-size:12px;color:var(--muted)}
    .right{margin-left:auto}
    .toggle{display:flex;align-items:center;gap:8px}
    .select-like{position:relative}
    .select-like select{appearance:none;padding-right:34px}
    .select-like:after{
      content:"‚ñæ";position:absolute;right:10px;top:10px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">
        <div class="logo-badge" aria-hidden="true">
          <!-- ÿ£ŸäŸÇŸàŸÜÿ© ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ© + ÿßŸÑŸÖÿÆÿ∑ÿ∑ + ÿßŸÑÿπÿØÿ≥ÿ© + ÿßŸÑÿµÿ≠ -->
          <svg viewBox="0 0 24 24">
            <path d="M3 7.5A2.5 2.5 0 0 1 5.5 5H16l.6 1.8H6a2 2 0 0 0-2 2v8.2A2 2 0 0 0 6 19h11a2 2 0 0 0 2-2v-4h-4.3a2.7 2.7 0 1 1 0-5.4H19a2 2 0 0 1 2 2V17a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V9.5Z"/>
          </svg>
        </div>
        <h1>Smart Budget</h1>
      </div>

      <div class="toolbar">
        <input id="nameInput" class="input" placeholder="Your name"/>
        <div class="select-like"><select id="currencySel" class="input">
          <option value="‚Ç¨">‚Ç¨ EUR</option><option value="$">$ USD</option><option value="¬£">¬£ GBP</option>
        </select></div>
        <div class="select-like"><select id="themeSel" class="input">
          <option value="Blue">Blue</option><option value="Sage">Sage</option><option value="Sand">Sand</option>
        </select></div>
        <button id="googleBtn" class="btn">Sign in with Google</button>
        <button id="notifBtn" class="btn ghost">Enable Notifications üîî</button>
        <div class="toggle">
          <label class="muted">Dark</label>
          <input type="checkbox" id="darkToggle">
        </div>
      </div>
    </header>

    <nav class="tabs" id="tabs">
      <button data-tab="dash" class="tab active">Dashboard</button>
      <button data-tab="commit" class="tab">Commitments</button>
      <button data-tab="exp" class="tab">Expenses</button>
      <button data-tab="save" class="tab">Savings</button>
      <button data-tab="events" class="tab">Events</button>
      <button data-tab="notes" class="tab">Notes</button>
      <button data-tab="analysis" class="tab">Analysis</button>
    </nav>

    <!-- Dashboard -->
    <section id="dash" class="card">
      <h2>Welcome, <span id="welcomeName">Guest</span> üëã</h2>
      <div class="card muted" style="margin-top:10px">
        ‚ÄúTrack your money. Master your life.‚Äù
      </div>
      <div class="grid grid-2">
        <div class="card">
          <div class="stat">
            <div>
              <div class="muted">Total Balance</div>
              <div id="statBalance" style="font-size:28px;font-weight:800">‚Ç¨ 0.00</div>
              <div class="hint">Income ‚àí Out</div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="stat">
            <div>
              <div class="muted">Total Expenses (month)</div>
              <div id="statExp" style="font-size:28px;font-weight:800">‚Ç¨ 0.00</div>
              <div class="hint">variable</div>
            </div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="muted">% Commitments Paid</div>
        <progress id="paidProg" max="100" value="0" style="width:100%;height:12px"></progress>
        <div class="hint" id="paidHint">0% (0/0)</div>
      </div>
      <div class="card">
        <div class="muted">Next Event</div>
        <div id="nextEvent">‚Äî</div>
      </div>
    </section>

    <!-- Commitments -->
    <section id="commit" class="card" hidden>
      <h2>Commitments (Fixed Payments)</h2>
      <div class="row">
        <input id="cName" class="input grow" placeholder="Commitment name"/>
        <div class="select-like grow">
          <select id="cCat" class="input">
            <option>Rent / Mortgage</option><option>Electricity</option><option>Water</option>
            <option>Internet & Phone</option><option>Insurance</option><option>Gym / Fitness</option>
            <option>Healthcare / Medicine</option><option>Subscriptions</option><option>Gifts & Celebrations</option>
            <option>Taxes & Fees</option><option>Savings / Investments</option><option>Miscellaneous</option>
          </select>
        </div>
        <input id="cMonthly" class="input" type="number" step="0.01" placeholder="Monthly amount"/>
        <input id="cDue" class="input" type="date"/>
        <button id="cAdd" class="btn">+ Add</button>
      </div>

      <div class="row" style="margin-top:8px">
        <div class="muted">Legend:</div>
        <span class="pill ok">Paid</span>
        <span class="pill warn">Due ‚â§3d</span>
        <span class="pill bad">Overdue</span>
        <span class="right muted">Total: <b id="cTotal">‚Ç¨ 0.00</b></span>
      </div>

      <div class="card">
        <table id="cTable">
          <thead><tr>
            <th>Name</th><th>Category</th><th>Monthly</th><th>Due</th><th>Status</th><th>Notes</th><th></th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="muted" id="nextDue">Next due in ‚Äî days</div>
    </section>

    <!-- Expenses -->
    <section id="exp" class="card" hidden>
      <h2>Expenses (Variable)</h2>
      <div class="row">
        <input id="eDate" class="input" type="date"/>
        <div class="select-like"><select id="eCat" class="input">
          <option>Groceries</option><option>Coffee & Snacks</option><option>Dining Out</option>
          <option>Household Supplies</option><option>Fuel / Gas</option><option>Public Transport</option>
          <option>Car Maintenance</option><option>Healthcare / Medicine</option><option>Personal Care</option>
          <option>Clothing & Accessories</option><option>Entertainment</option><option>Hobbies & Subscriptions</option>
          <option>Courses & Learning</option><option>Books & Materials</option><option>Work Expenses</option>
          <option>Software & Apps</option><option>Savings / Investments</option>
          <option>Travel</option><option>Accommodation</option><option>Activities & Tickets</option>
          <option>Donations & Charity</option><option>Taxes & Fees</option><option>Miscellaneous</option>
        </select></div>
        <input id="eDesc" class="input grow" placeholder="Description"/>
        <input id="eAmt" class="input" type="number" step="0.01" placeholder="Amount"/>
        <div class="select-like"><select id="eMethod" class="input">
          <option>Card</option><option>Cash</option><option>Transfer</option><option>Other</option>
        </select></div>
        <button id="eAdd" class="btn">+ Add</button>
      </div>

      <div class="row" style="margin-top:8px">
        <span class="muted">Total: <b id="eTotal">‚Ç¨ 0.00</b></span>
        <span class="muted">Top 3: <b id="eTop">‚Äî</b></span>
        <span class="muted right">Avg/day: <b id="eAvg">‚Ç¨ 0.00</b></span>
      </div>

      <div class="card">
        <table id="eTable">
          <thead><tr>
            <th>Date</th><th>Category</th><th>Description</th><th>Amount</th><th>Method</th><th></th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Savings -->
    <section id="save" class="card" hidden>
      <h2>Saving Plans</h2>
      <div class="row">
        <input id="sName" class="input grow" placeholder="Goal name"/>
        <div class="select-like"><select id="sCat" class="input">
          <option>Vacation</option><option>Wedding</option><option>Investment</option><option>Other</option>
        </select></div>
        <input id="sTarget" class="input" type="number" step="0.01" placeholder="Target amount"/>
        <input id="sMonths" class="input" type="number" min="1" placeholder="Duration (months)"/>
        <input id="sStart" class="input" type="date"/>
        <input id="sEnd" class="input" type="date"/>
        <label class="input" style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="sToCommit"> Add to Commitments
        </label>
        <button id="sAdd" class="btn">+ Add</button>
      </div>
      <div class="card">
        <table id="sTable">
          <thead><tr>
            <th>Goal</th><th>Category</th><th>Target</th><th>Months</th><th>Monthly</th><th>Period</th><th></th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Events -->
    <section id="events" class="card" hidden>
      <h2>Events & Gifts</h2>
      <div class="row">
        <input id="vName" class="input grow" placeholder="Event name"/>
        <div class="select-like"><select id="vType" class="input">
          <option>Birthday</option><option>Wedding</option><option>Holiday</option>
          <option>Gift</option><option>Other</option>
        </select></div>
        <input id="vDate" class="input" type="date"/>
        <input id="vSpend" class="input" type="number" step="0.01" placeholder="Planned Spending"/>
        <label class="input" style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="vToCommit"> Add to Commitments
        </label>
        <button id="vAdd" class="btn">+ Add</button>
      </div>
      <div class="hint" style="margin-top:6px">
        Reminder colors: ‚â§30d (blue) ¬∑ ‚â§7d (orange) ¬∑ ‚â§3d (red) ¬∑ past (gray)
      </div>
      <div class="card">
        <table id="vTable">
          <thead><tr>
            <th>Event</th><th>Type</th><th>Date</th><th>Planned</th><th>Reminders</th><th></th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Notes -->
    <section id="notes" class="card" hidden>
      <h2>Notes</h2>
      <textarea id="notesArea" class="input" style="width:100%;height:200px" placeholder="Write anything here..."></textarea>
      <div class="hint">Autosaves locally & syncs to cloud when signed in.</div>
    </section>

    <!-- Analysis -->
    <section id="analysis" class="card" hidden>
      <h2>Analysis</h2>
      <div class="grid grid-2">
        <div class="card">
          <h3>Monthly by Category</h3>
          <canvas id="chart1" height="220"></canvas>
        </div>
        <div class="card">
          <h3>Commitments Paid %</h3>
          <canvas id="chart2" height="220"></canvas>
        </div>
      </div>
      <div class="card">
        <h3>Helper formulas (Google Sheets)</h3>
        <ul class="muted">
          <li>Days to Event: <code>= [Event_Date] - TODAY()</code></li>
          <li>Months to Save: <code>=DATEDIF([Start_Date],[End_Date],"M")+1</code></li>
          <li>Monthly Contribution: <code>=ROUNDUP([Target]/[Months],2)</code></li>
          <li>Status: <code>=IF([Paid]>=[Amount],"Paid",IF([Due]&lt;TODAY(),"Overdue",IF([Due]-TODAY()&lt;=3,"Due Soon","Pending")))</code></li>
          <li>SUM per category: <code>=SUMIF([Category],[X],[Amount])</code></li>
        </ul>
      </div>
    </section>
  </div>

  <!-- Chart.js (ŸÑŸÑÿßÿÆÿ™ÿµÿßÿ±Ÿá ŸÜÿ≥ÿ™ÿÆÿØŸÖ ŸÜÿ≥ÿÆÿ© ÿÆŸÅŸäŸÅÿ©) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
  // =============== ÿ™ŸáŸäÿ¶ÿ© ÿ®ÿ≥Ÿäÿ∑ÿ© ŸÑÿ≠ŸÅÿ∏ ÿßŸÑÿ≠ÿßŸÑÿ© ===============
  const $ = (q, p=document) => p.querySelector(q);
  const $$ = (q, p=document) => [...p.querySelectorAll(q)];
  const state = {
    user:null, currency:"‚Ç¨", themeAccent:"Blue", dark:false, name:"",
    commitments:[], expenses:[], savings:[], events:[], notes:""
  };
  const key = 'sb_v2';

  function loadLocal(){
    try{
      const s = JSON.parse(localStorage.getItem(key)||'{}');
      Object.assign(state, s);
    }catch{}
  }
  function saveLocal(){
    localStorage.setItem(key, JSON.stringify(state));
  }

  // =============== Firebase ===============
  let app, auth, db;
  window.addEventListener('load', async () => {
    // ÿ®ÿØŸëŸÑŸä ÿßŸÑŸÇŸäŸÖ ÿ£ÿØŸÜÿßŸá ÿ®ŸÇŸäŸÖ ŸÖÿ¥ÿ±ŸàÿπŸÉ (ŸÖŸÜ ÿµŸÅÿ≠ÿ© Project settings)
    const firebaseConfig = {
      apiKey: "REPLACE_ME",
      authDomain: "REPLACE_ME.firebaseapp.com",
      projectId: "REPLACE_ME",
      storageBucket: "REPLACE_ME.appspot.com",
      messagingSenderId: "REPLACE_ME",
      appId: "REPLACE_ME"
    };
    app = firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    db = firebase.firestore();
  });

  async function syncFromCloud(){
    if(!state.user) return;
    const doc = await db.collection('users').doc(state.user.uid).get();
    if(doc.exists){
      const cloud = doc.data();
      // ŸÜÿØŸÖÿ¨ ÿ®ÿØŸàŸÜ ŸÅŸÇÿØ ŸÖÿ≠ŸÑŸä
      ['commitments','expenses','savings','events','notes','name','currency','themeAccent','dark'].forEach(k=>{
        if(cloud[k]!==undefined) state[k]=cloud[k];
      });
      saveLocal(); renderAll();
    }
  }
  async function syncToCloud(){
    if(!state.user) return;
    const payload = {
      name:state.name,currency:state.currency,themeAccent:state.themeAccent,dark:state.dark,
      commitments:state.commitments,expenses:state.expenses,savings:state.savings,
      events:state.events,notes:state.notes, updatedAt: new Date()
    };
    await db.collection('users').doc(state.user.uid).set(payload,{merge:true});
  }

  // =============== OneSignal ===============
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal){
    await OneSignal.init({
      appId: "5dbef29c-1d7a-403d-9399-b2566983cc30",
      notifyButton: { enable: false }
    });
    window.requestPush = () => OneSignal.Notifications.requestPermission();
  });

  // =============== PWA: manifest + ServiceWorker ===============
  // ŸÜŸàŸÑŸëÿØ manifest ÿ£ŸäŸÇŸàŸÜÿßÿ™ ÿ£ÿ≥ÿßÿ≥Ÿäÿ© (ŸäŸÖŸÉŸÜ ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ÿßŸÑÿ±Ÿàÿßÿ®ÿ∑ ŸÑÿßÿ≠ŸÇŸãÿß)
  const icons = [
    {src:"/icons/icon-192.png",sizes:"192x192",type:"image/png"},
    {src:"/icons/icon-512.png",sizes:"512x512",type:"image/png"},
    {src:"/icons/maskable-512.png",sizes:"512x512",type:"image/png",purpose:"maskable"}
  ];
  const manifest = {
    name:"Smart Budget",
    short_name:"SmartBudget",
    start_url:"./",
    display:"standalone",
    background_color:"#0e2a44",
    theme_color:"#0e2a44",
    icons
  };
  const mURL = URL.createObjectURL(new Blob([JSON.stringify(manifest)],{type:'application/json'}));
  $('#manifestLink').setAttribute('href', mURL);

  // sw ÿ®ÿ≥Ÿäÿ∑ ŸÑŸÑÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑÿ£ŸàŸÅŸÑÿßŸäŸÜ
  const swCode = `
    const CACHE='sb-v2';
    const ASSETS = ['/', './', 'index.html',
      'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js',
      'https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js'
    ];
    self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)).then(()=>self.skipWaiting()))});
    self.addEventListener('activate',e=>{e.waitUntil(self.clients.claim())});
    self.addEventListener('fetch',e=>{
      const req=e.request;
      e.respondWith(caches.match(req).then(r=>r||fetch(req).then(res=>{
        const copy=res.clone(); caches.open(CACHE).then(c=>c.put(req, copy)); return res;
      }).catch(()=>r)));
    });
    // ÿßÿ≥ÿ™ŸÇÿ®ÿßŸÑ ÿ£ŸÖÿ± ÿπÿ±ÿ∂ ÿ™ŸÜÿ®ŸäŸá ŸÖÿ≠ŸÑŸä (ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿßŸÑŸÖŸàŸÇÿπ)
    self.addEventListener('message',e=>{
      const d=e.data||{};
      if(d.type==='notify') self.registration.showNotification(d.title||'Reminder',{body:d.body||'',icon:d.icon||null});
    });
  `;
  if('serviceWorker' in navigator){
    const swURL = URL.createObjectURL(new Blob([swCode],{type:'text/javascript'}));
    navigator.serviceWorker.register(swURL);
  }

  // =============== Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ & ŸÖŸÜÿ∑ŸÇ ÿßŸÑÿµŸÅÿ≠ÿßÿ™ ===============
  loadLocal();

  // ÿ•ÿπÿØÿßÿØÿßÿ™ ÿπÿßŸÖÿ©
  const nameInput = $('#nameInput'), curSel = $('#currencySel'), themeSel = $('#themeSel'),
        darkToggle = $('#darkToggle'), welcomeName = $('#welcomeName');

  function applyTheme(){
    document.documentElement.dataset.theme = state.dark ? 'dark' : 'light';
    // ÿ™ŸÑŸàŸäŸÜ ŸÜÿßÿπŸÖ ÿ≠ÿ≥ÿ® ÿßŸÑŸÄ accent (ÿ®ÿ¥ŸÉŸÑ ÿ®ÿ≥Ÿäÿ∑)
    const map = {Blue:'var(--blue)', Sage:'var(--sage)', Sand:'var(--sand)'};
    document.querySelectorAll('.tab:not(.active)').forEach(t=>t.style.background = getComputedStyle(document.documentElement).getPropertyValue('--soft'));
    document.querySelectorAll('.card').forEach(c=>c.style.borderColor='transparent');
    document.body.style.background = getComputedStyle(document.documentElement).getPropertyValue('--bg');
  }

  function bindBasics(){
    nameInput.value = state.name||'';
    curSel.value = state.currency||'‚Ç¨';
    themeSel.value = state.themeAccent||'Blue';
    darkToggle.checked = !!state.dark;
    welcomeName.textContent = state.name || 'Guest';

    nameInput.oninput = () => {state.name = nameInput.value; welcomeName.textContent = state.name||'Guest'; saveLocal(); syncToCloud()};
    curSel.onchange = () => {state.currency = curSel.value; saveLocal(); renderAll(); syncToCloud()};
    themeSel.onchange = () => {state.themeAccent = themeSel.value; saveLocal(); applyTheme(); syncToCloud()};
    darkToggle.onchange = () => {state.dark = darkToggle.checked; saveLocal(); applyTheme(); syncToCloud()};
    $('#notifBtn').onclick = () => window.requestPush && window.requestPush();
  }

  // ÿ™ÿ®ŸàŸäÿ®
  $$('#tabs .tab').forEach(t=>{
    t.onclick = ()=> {
      $$('#tabs .tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      ['dash','commit','exp','save','events','notes','analysis'].forEach(id=>{
        $('#'+id).hidden = id !== t.dataset.tab;
      });
      if(t.dataset.tab==='analysis') drawCharts();
    }
  });

  // ===== Commitments =====
  const cBody = $('#cTable tbody');
  function renderCommitments(){
    cBody.innerHTML = '';
    let paid = 0, total = 0, soon = Infinity;
    const today = new Date();
    state.commitments.forEach((r,idx)=>{
      total += (+r.amount||0);
      const tr = document.createElement('tr');
      const due = new Date(r.due);
      const days = Math.ceil((due - today)/(1000*60*60*24));
      let status = r.paid ? 'Paid' : (days < 0 ? 'Overdue' : (days<=3?'Due soon':'Pending'));
      if(r.paid) paid++;
      if(days>=0) soon = Math.min(soon, days);

      tr.innerHTML = `
        <td>${r.name||''}</td>
        <td>${r.cat||''}</td>
        <td>${fmt(r.amount)}</td>
        <td>${r.due||''}</td>
        <td>
          <span class="pill ${r.paid?'ok':(days<0?'bad':(days<=3?'warn':''))}">${status}</span>
          <label class="hint" style="margin-left:8px"><input type="checkbox" ${r.paid?'checked':''} data-idx="${idx}" class="cPaid"> Paid</label>
        </td>
        <td contenteditable data-idx="${idx}" class="cNote">${r.note||''}</td>
        <td><button class="btn ghost cDel" data-idx="${idx}">‚úï</button></td>
      `;
      cBody.appendChild(tr);
    });
    $('#cTotal').textContent = fmt(total);
    $('#nextDue').textContent = isFinite(soon) ? `Next due in ${soon} days` : 'Next due ‚Äî';
    // ÿ¥ÿ±Ÿäÿ∑ ŸÅŸä ÿßŸÑÿØÿßÿ¥ÿ®Ÿàÿ±ÿØ
    const pct = state.commitments.length? Math.round(100*paid/state.commitments.length):0;
    $('#paidProg').value = pct; $('#paidHint').textContent = `${pct}% (${paid}/${state.commitments.length})`;
    saveLocal(); syncToCloud();
  }
  $('#cAdd').onclick = ()=>{
    const r = {
      name:$('#cName').value.trim(),
      cat:$('#cCat').value,
      amount:+$('#cMonthly').value||0,
      due:$('#cDue').value,
      paid:false,note:""
    };
    if(!r.name || !r.due) return alert('Please add name & due date');
    state.commitments.push(r);
    $('#cName').value=''; $('#cMonthly').value=''; $('#cDue').value='';
    renderCommitments(); scheduleLocalReminders();
  };
  cBody.addEventListener('change',e=>{
    if(e.target.classList.contains('cPaid')){
      const i = +e.target.dataset.idx; state.commitments[i].paid = e.target.checked;
      renderCommitments();
    }
  });
  cBody.addEventListener('click',e=>{
    if(e.target.classList.contains('cDel')){
      const i = +e.target.dataset.idx; state.commitments.splice(i,1); renderCommitments();
    }
  });
  cBody.addEventListener('input',e=>{
    if(e.target.classList.contains('cNote')){
      const i = +e.target.dataset.idx; state.commitments[i].note = e.target.textContent; saveLocal(); syncToCloud();
    }
  });

  // ===== Expenses =====
  const eBody = $('#eTable tbody');
  $('#eDate').value = new Date().toISOString().slice(0,10);
  $('#eAdd').onclick=()=>{
    const r = {
      date:$('#eDate').value, cat:$('#eCat').value, desc:$('#eDesc').value,
      amt:+$('#eAmt').value||0, method:$('#eMethod').value
    };
    if(!r.date || !r.amt) return;
    state.expenses.unshift(r);
    $('#eDesc').value=''; $('#eAmt').value='';
    renderExpenses();
  };
  function renderExpenses(){
    eBody.innerHTML='';
    let total=0; const byCat={}; let minD=Infinity,maxD=-Infinity, cnt=0;
    state.expenses.forEach((r,i)=>{
      total += r.amt; byCat[r.cat]=(byCat[r.cat]||0)+r.amt; cnt++;
      const d=new Date(r.date).getTime(); minD=Math.min(minD,d); maxD=Math.max(maxD,d);
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${r.date}</td><td>${r.cat}</td><td>${r.desc||''}</td>
        <td>${fmt(r.amt)}</td><td>${r.method}</td>
        <td><button class="btn ghost eDel" data-idx="${i}">‚úï</button></td>
      `;
      eBody.appendChild(tr);
    });
    $('#eTotal').textContent = fmt(total);
    const top = Object.entries(byCat).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([k,v])=>`${k} (${fmt(v)})`).join(', ')||'‚Äî';
    $('#eTop').textContent = top;
    const days = isFinite(minD)&&isFinite(maxD)? Math.max(1, Math.round((maxD-minD)/(1000*60*60*24))+1) : 1;
    $('#eAvg').textContent = fmt(total/days);
    saveLocal(); syncToCloud(); updateStats();
  }
  eBody.addEventListener('click',e=>{
    if(e.target.classList.contains('eDel')){
      const i=+e.target.dataset.idx; state.expenses.splice(i,1); renderExpenses();
    }
  });

  // ===== Savings =====
  const sBody = $('#sTable tbody');
  $('#sAdd').onclick=()=>{
    const m = Math.max(1, +$('#sMonths').value||0);
    const r = {
      name:$('#sName').value.trim(), cat:$('#sCat').value, target:+$('#sTarget').value||0,
      months:m, monthly: Math.ceil((+$('#sTarget').value||0)/m*100)/100,
      start:$('#sStart').value, end:$('#sEnd').value, addToCommit: $('#sToCommit').checked
    };
    if(!r.name||!r.target||!m) return;
    state.savings.push(r);
    if(r.addToCommit){
      state.commitments.push({
        name:`Saving ‚Äì ${r.name}`, cat:'Savings / Investments', amount:r.monthly,
        due:r.end||new Date().toISOString().slice(0,10), paid:false, note:''
      });
    }
    ['sName','sTarget','sMonths','sStart','sEnd'].forEach(id=>$('#'+id).value='');
    $('#sToCommit').checked=false;
    renderSavings(); renderCommitments();
  };
  function renderSavings(){
    sBody.innerHTML='';
    state.savings.forEach((r,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${r.name}</td><td>${r.cat}</td><td>${fmt(r.target)}</td>
        <td>${r.months}</td><td>${fmt(r.monthly)}</td>
        <td>${r.start||''} ‚Üí ${r.end||''}</td>
        <td><button class="btn ghost sDel" data-idx="${i}">‚úï</button></td>
      `;
      sBody.appendChild(tr);
    });
    saveLocal(); syncToCloud();
  }
  sBody.addEventListener('click',e=>{
    if(e.target.classList.contains('sDel')){
      const i=+e.target.dataset.idx; state.savings.splice(i,1); renderSavings();
    }
  });

  // ===== Events =====
  const vBody = $('#vTable tbody');
  $('#vAdd').onclick=()=>{
    const r = {
      name:$('#vName').value.trim(), type:$('#vType').value, date:$('#vDate').value,
      planned:+$('#vSpend').value||0, addToCommit:$('#vToCommit').checked
    };
    if(!r.name||!r.date) return;
    state.events.push(r);
    if(r.addToCommit){
      state.commitments.push({
        name:`Gift ‚Äì ${r.name}`, cat:'Gifts & Celebrations', amount:r.planned,
        due:r.date, paid:false, note:''
      });
    }
    ['vName','vSpend','vDate'].forEach(id=>$('#'+id).value='');
    $('#vToCommit').checked=false;
    renderEvents(); renderCommitments(); scheduleLocalReminders();
  };
  function renderEvents(){
    vBody.innerHTML='';
    const today = new Date();
    let nextTxt='‚Äî', nextDelta=Infinity;
    state.events.forEach((r,i)=>{
      const d = new Date(r.date);
      const delta = Math.ceil((d - today)/(1000*60*60*24));
      let color='#9aa7b3';
      if(delta<=30 && delta>7) color='#5fa8ff';
      if(delta<=7 && delta>3) color='#ffb759';
      if(delta<=3 && delta>=0) color='#ff6b6b';
      if(delta>=0 && delta<nextDelta){nextDelta=delta; nextTxt=`${r.name} in ${delta} days`;}
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${r.name}</td><td>${r.type}</td><td>${r.date}</td>
        <td>${fmt(r.planned)}</td>
        <td><span class="pill" style="background:${color};color:#10223a">Reminder</span></td>
        <td><button class="btn ghost vDel" data-idx="${i}">‚úï</button></td>
      `;
      vBody.appendChild(tr);
    });
    $('#nextEvent').textContent = nextTxt;
    vBody.onclick = (e)=>{
      if(e.target.classList.contains('vDel')){
        const i=+e.target.dataset.idx; state.events.splice(i,1); renderEvents(); scheduleLocalReminders();
      }
    };
    saveLocal(); syncToCloud();
  }

  // ===== Notes =====
  $('#notesArea').addEventListener('input', e=>{
    state.notes = e.target.value; saveLocal(); syncToCloud();
  });

  // ===== ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿ≥ÿ±Ÿäÿπÿ© =====
  function fmt(n){ return `${state.currency} ${(+n||0).toFixed(2)}`;}
  function updateStats(){
    const totalExp = state.expenses.reduce((a,b)=>a+(+b.amt||0),0);
    $('#statExp').textContent = fmt(totalExp);
    // balance ŸÖÿ´ÿßŸÑ ÿ®ÿ≥Ÿäÿ∑: (ŸÖÿØÿÆŸÑÿßÿ™ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©ÿå ŸÜŸÅÿ™ÿ±ÿ∂ ŸÅŸÇÿ∑ -ÿßŸÑŸÖÿµÿ±ŸàŸÅÿßÿ™)
    $('#statBalance').textContent = fmt(-totalExp);
  }

  // ===== Charts =====
  let ch1,ch2;
  function drawCharts(){
    const byCat={}; state.expenses.forEach(e=>byCat[e.cat]=(byCat[e.cat]||0)+(+e.amt||0));
    const ctx1=$('#chart1').getContext('2d');
    ch1 && ch1.destroy();
    ch1 = new Chart(ctx1,{type:'doughnut',data:{
      labels:Object.keys(byCat),
      datasets:[{data:Object.values(byCat)}]
    }});

    const paid=state.commitments.filter(c=>c.paid).length;
    const tot=state.commitments.length||1;
    const ctx2=$('#chart2').getContext('2d');
    ch2 && ch2.destroy();
    ch2 = new Chart(ctx2,{type:'bar',data:{
      labels:['Paid','Pending'],
      datasets:[{data:[paid,tot-paid]}]
    }});
  }

  // ===== ÿ™ŸÜÿ®ŸäŸáÿßÿ™ ŸÖÿ≠ŸÑŸäÿ© (ÿπÿ®ÿ± ServiceWorker ÿ≠ŸäŸÜ ŸäŸÉŸàŸÜ ÿßŸÑŸÖŸàŸÇÿπ ŸÖŸÅÿ™Ÿàÿ≠/ŸÖÿ´ÿ®Ÿëÿ™) =====
  function scheduleLocalReminders(){
    if(!navigator.serviceWorker?.controller) return;
    const today = new Date();
    // ÿßŸÑÿ™ÿ≤ÿßŸÖÿßÿ™
    state.commitments.forEach(c=>{
      if(c.paid||!c.due) return;
      const d = new Date(c.due);
      const delta = Math.ceil((d - today)/(1000*60*60*24));
      if(delta<=3 && delta>=0){
        navigator.serviceWorker.controller.postMessage({
          type:'notify', title:'Commitment due soon',
          body:`${c.name} in ${delta} day(s)`
        });
      }
      if(delta<0){
        navigator.serviceWorker.controller.postMessage({
          type:'notify', title:'Overdue payment',
          body:`${c.name} is overdue`
        });
      }
    });
    // ÿ£ÿ≠ÿØÿßÿ´
    state.events.forEach(ev=>{
      const d = new Date(ev.date);
      const delta = Math.ceil((d - today)/(1000*60*60*24));
      if([30,7,3].includes(delta)){
        navigator.serviceWorker.controller.postMessage({
          type:'notify', title:'Event reminder',
          body:`${ev.name} in ${delta} day(s)`
        });
      }
    });
  }

  // ===== ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÇŸàŸÇŸÑ =====
  $('#googleBtn').onclick = async ()=>{
    try{
      const provider = new firebase.auth.GoogleAuthProvider();
      const res = await auth.signInWithPopup(provider);
      state.user = res.user; saveLocal();
      $('#googleBtn').textContent = 'Signed in ‚úì';
      await syncFromCloud(); renderAll();
    }catch(err){
      alert('Google sign-in failed. Make sure your domain is authorized in Firebase.');
      console.error(err);
    }
  };

  // ===== ÿ™ŸáŸäÿ¶ÿ© ÿ£ŸàŸÑŸäÿ© =====
  function renderAll(){
    bindBasics(); applyTheme();
    renderCommitments(); renderExpenses(); renderSavings(); renderEvents();
    $('#notesArea').value = state.notes||'';
    updateStats();
  }
  renderAll();
  // ÿ£ÿπŸêÿØ ÿ¨ÿØŸàŸÑÿ© ÿßŸÑÿ™ÿ∞ŸÉŸäÿ±ÿßÿ™ ŸÉŸÑŸÖÿß ÿ™ÿ∫ŸäŸëÿ± ÿ¥Ÿäÿ°
  ['commitments','events'].forEach(k=>{
    const orig = state.__defineSetter__ ? null : null; // placeholder
  });
  setInterval(scheduleLocalReminders, 60*1000); // ŸÅÿ≠ÿµ ŸÉŸÑ ÿØŸÇŸäŸÇÿ© ÿÆŸÅŸäŸÅÿ©

  </script>
</body>
  </html>
