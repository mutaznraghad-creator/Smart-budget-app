<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Budget</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0e5bd8">
  <link rel="icon" href="/icons/icon-192.png">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #f6f7f9;
      --card: #ffffff;
      --ink: #24364d;
      --muted: #5c6b7a;
      --soft: #e8eef8;
      --brand: #2c74ff; /* Blue */
      --ok: #2fc087;
      --warn: #ffbe3b;
      --bad: #ff8a8a;
    }
    [data-theme="Sage"]  { --brand:#2b8a68; --soft:#e6f1ed; }
    [data-theme="Sand"]  { --brand:#c59d5f; --soft:#efe7d8; }

    * { box-sizing: border-box }
    body {
      margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: var(--bg); color: var(--ink);
    }
    .wrap { max-width:1100px; margin:0 auto; padding:16px; }
    header{ display:flex; align-items:center; gap:16px; flex-wrap:wrap; }
    .logo{ display:flex; align-items:center; gap:10px; }
    .logo img{ width:32px; height:32px; border-radius:8px }
    h1{ font-size:28px; margin:0; }
    .controls{ display:flex; gap:10px; margin-left:auto; flex-wrap:wrap; }
    select, input, button {
      height:40px; padding:0 12px; border-radius:10px; border:1px solid #d6dbe3; background:#fff;
      color:var(--ink); outline:none;
    }
    button.brand { background: var(--brand); color:#fff; border-color: transparent; }
    button.ghost { background:transparent }
    nav { margin:16px 0; display:flex; gap:10px; flex-wrap:wrap; }
    nav button { background:#edf1fb; color:#1f3b7a; }
    nav button.active { background: var(--brand); color:#fff; }
    .card{ background:var(--card); border-radius:18px; padding:18px; box-shadow: 0 6px 18px rgba(0,0,0,.06); }

    .grid{ display:grid; gap:14px; }
    @media(min-width:900px){ .grid.cols-3{ grid-template-columns:1fr 1fr 1fr } }

    .stat h3{ margin:0 0 6px; font-size:14px; color:var(--muted) }
    .stat .big{ font-size:28px; font-weight:800 }

    table{ width:100%; border-collapse: collapse; }
    th, td{ text-align:left; padding:10px 8px; border-bottom:1px solid #eef1f6; font-size:14px }
    th{ color:var(--muted); font-weight:600 }
    .badge{ display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:100px; font-size:12px; }
    .paid{ background:#e6fbf4; color:#0a7a57 }
    .soon{ background:#fff6e4; color:#916300 }
    .over{ background:#ffecec; color:#9b1c1c }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > * { flex:1; min-width:180px }
    .hint{ color:var(--muted); font-size:13px }
    .progress{ height:10px; background:#eef2f7; border-radius:999px; overflow:hidden }
    .progress > i{ display:block; height:100%; background:var(--brand); width:0% }

    .toast{ position: fixed; left:50%; transform:translateX(-50%); bottom:18px; background:var(--ink); color:#fff; padding:12px 16px; border-radius:12px; opacity:0; pointer-events:none; transition:.2s }
    .toast.show{ opacity:1 }
  </style>
</head>
<body>
<div class="wrap" id="app" data-theme="Blue">

  <header>
    <div class="logo">
      <img src="/icons/icon-192.png" alt="logo">
      <h1>Smart Budget</h1>
    </div>

    <div class="controls">
      <input id="nameInput" placeholder="Your name" style="width:160px">
      <select id="currencySel">
        <option value="‚Ç¨">‚Ç¨ EUR</option>
        <option value="$">$ USD</option>
        <option value="¬£">¬£ GBP</option>
      </select>
      <select id="themeSel">
        <option>Blue</option><option>Sage</option><option>Sand</option>
      </select>

      <button id="btnSign" class="brand">Sign in with Google</button>
      <button id="btnOut" class="ghost" style="display:none">Sign out</button>
      <button id="btnNotif" class="ghost">Enable Notifications üîî</button>
    </div>
  </header>

  <nav>
    <button class="active" data-tab="dashboard">Dashboard</button>
    <button data-tab="commitments">Commitments</button>
    <button data-tab="expenses">Expenses</button>
  </nav>

  <!-- Dashboard -->
  <section id="dashboard" class="card">
    <h2>Welcome, <span id="welcomeName">Guest</span> üëã</h2>
    <blockquote class="card" style="margin:12px 0 16px; border:1px dashed var(--soft); background:#fafcff">
      ‚ÄúTrack your money. Master your life.‚Äù
    </blockquote>

    <div class="grid cols-3">
      <div class="card stat">
        <h3>Total Balance <span class="hint">Income ‚àí Out</span></h3>
        <div class="big" id="statBalance">‚Ç¨ 0.00</div>
      </div>
      <div class="card stat">
        <h3>Total Expenses (month)</h3>
        <div class="big" id="statExpenses">‚Ç¨ 0.00</div>
      </div>
      <div class="card stat">
        <h3>% Commitments Paid</h3>
        <div class="progress"><i id="paidBar"></i></div>
        <div class="hint"><span id="paidPct">0%</span> (<span id="paidCount">0/0</span>)</div>
      </div>
    </div>
  </section>

  <!-- Commitments -->
  <section id="commitments" class="card" style="display:none">
    <h2>Commitments (Fixed Payments)</h2>
    <div class="row" style="margin-top:10px">
      <input id="c_name" placeholder="Commitment name">
      <select id="c_cat">
        <option>Groceries</option><option>Coffee & Snacks</option><option>Dining Out</option>
        <option>Household Supplies</option><option>Fuel / Gas</option><option>Public Transport</option>
        <option>Car Maintenance</option><option>Rent / Mortgage</option><option>Electricity</option>
        <option>Water</option><option>Internet & Phone</option><option>Home Maintenance</option>
        <option>Healthcare / Medicine</option><option>Insurance</option><option>Gym / Fitness</option>
        <option>Personal Care</option><option>Clothing & Accessories</option><option>Gifts & Celebrations</option>
        <option>Entertainment</option><option>Hobbies & Subscriptions</option><option>Courses & Learning</option>
        <option>Books & Materials</option><option>Work Expenses</option><option>Software & Apps</option>
        <option>Savings / Investments</option><option>Travel</option><option>Accommodation</option>
        <option>Activities & Tickets</option><option>Donations & Charity</option><option>Taxes & Fees</option>
        <option>Miscellaneous</option>
      </select>
      <input id="c_amount" type="number" min="0" step="0.01" placeholder="Monthly amount">
      <input id="c_due" type="date">
      <button id="c_add" class="brand">+ Add</button>
    </div>

    <div class="hint" style="margin:10px 0">Status colors: <span class="badge paid">Paid</span> <span class="badge soon">Due ‚â§ 3 days</span> <span class="badge over">Overdue</span></div>

    <div class="card" style="margin-top:14px; overflow:auto">
      <table>
        <thead>
          <tr>
            <th>Name</th><th>Category</th><th>Monthly</th><th>Due</th><th>Status</th><th>Notes</th><th></th>
          </tr>
        </thead>
        <tbody id="c_tbody"></tbody>
      </table>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="card stat"><h3>Total</h3><div class="big" id="c_total">‚Ç¨ 0.00</div></div>
      <div class="card stat"><h3>Paid this month</h3><div class="big" id="c_paid_count">0</div></div>
      <div class="card stat"><h3>Next due in</h3><div class="big" id="c_next_due">‚Äî</div></div>
    </div>
  </section>

  <!-- Expenses -->
  <section id="expenses" class="card" style="display:none">
    <h2>Expenses (Variable)</h2>
    <div class="row" style="margin-top:10px">
      <input id="e_date" type="date">
      <select id="e_cat">
        <option>Groceries</option><option>Coffee & Snacks</option><option>Dining Out</option>
        <option>Household Supplies</option><option>Fuel / Gas</option><option>Public Transport</option>
        <option>Car Maintenance</option><option>Electricity</option><option>Water</option><option>Internet & Phone</option>
        <option>Home Maintenance</option><option>Healthcare / Medicine</option><option>Insurance</option><option>Gym / Fitness</option>
        <option>Personal Care</option><option>Clothing & Accessories</option><option>Gifts & Celebrations</option>
        <option>Entertainment</option><option>Hobbies & Subscriptions</option><option>Courses & Learning</option>
        <option>Books & Materials</option><option>Work Expenses</option><option>Software & Apps</option>
        <option>Savings / Investments</option><option>Travel</option><option>Accommodation</option>
        <option>Activities & Tickets</option><option>Donations & Charity</option><option>Taxes & Fees</option>
        <option>Miscellaneous</option>
      </select>
      <input id="e_desc" placeholder="Description">
      <input id="e_amount" type="number" min="0" step="0.01" placeholder="Amount">
      <select id="e_method"><option>Card</option><option>Cash</option><option>Transfer</option><option>Other</option></select>
      <button id="e_add" class="brand">+ Add</button>
    </div>

    <div class="card" style="margin-top:14px; overflow:auto">
      <table>
        <thead><tr><th>Date</th><th>Category</th><th>Description</th><th>Amount</th><th>Method</th><th></th></tr></thead>
        <tbody id="e_tbody"></tbody>
      </table>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="card stat"><h3>Total (month)</h3><div class="big" id="e_total">‚Ç¨ 0.00</div></div>
      <div class="card stat"><h3>Top 3 categories</h3><div id="e_top3" class="hint">‚Äî</div></div>
      <div class="card stat"><h3>Avg/day</h3><div class="big" id="e_avg">‚Ç¨ 0.00</div></div>
    </div>
  </section>

  <div class="toast" id="toast">Saved</div>
</div>

<!-- Firebase (modular v10 CDN) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
  import { getFirestore, enableIndexedDbPersistence, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

  // --- Firebase config (ŸÖŸÜ ŸÖÿ¥ÿ±ŸàÿπŸÉ) ---
  const firebaseConfig = {
    apiKey: "AIzaSyCfnCTuunR_E15GQaPQyUbS2Fdj6XAYfUo",
    authDomain: "smart-budget-61664.firebaseapp.com",
    projectId: "smart-budget-61664",
    storageBucket: "smart-budget-61664.firebasestorage.app",
    messagingSenderId: "273780649075",
    appId: "1:273780649075:web:c0c08d6d5f65085e9e0e06",
    measurementId: "G-FNJJPP90FH"
  };

  const appFB = initializeApp(firebaseConfig);
  const auth = getAuth(appFB);
  const db = getFirestore(appFB);
  try { await enableIndexedDbPersistence(db) } catch(e){ console.warn('persistence', e) }

  // --- Elements ---
  const $ = (s)=>document.querySelector(s);
  const $$ = (s)=>document.querySelectorAll(s);
  const app = $('#app');
  const btnSign=$('#btnSign'), btnOut=$('#btnOut');
  const nameInput=$('#nameInput'), welcomeName=$('#welcomeName');
  const currencySel=$('#currencySel'), themeSel=$('#themeSel');
  const toast=$("#toast");
  function showToast(msg){ toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1500) }

  // --- Theme/Currency persistence ---
  const savedTheme = localStorage.getItem('sb_theme') || 'Blue';
  const savedCurr  = localStorage.getItem('sb_curr') || '‚Ç¨';
  themeSel.value = savedTheme; app.dataset.theme = savedTheme;
  currencySel.value = ['‚Ç¨ EUR','$ USD','¬£ GBP'].find(x=>x.startsWith(savedCurr))?currencySel.value:savedCurr;
  themeSel.onchange = ()=>{ app.dataset.theme = themeSel.value; localStorage.setItem('sb_theme', themeSel.value) }
  currencySel.onchange = ()=> localStorage.setItem('sb_curr', currencySel.value[0]);

  // --- Tabs ---
  $$('nav button').forEach(b=>b.onclick = ()=>{
    $$('nav button').forEach(x=>x.classList.remove('active')); b.classList.add('active');
    ['dashboard','commitments','expenses'].forEach(id => $('#'+id).style.display = (b.dataset.tab===id?'block':'none'));
  });

  // --- Auth ---
  const provider = new GoogleAuthProvider();
  btnSign.onclick = async ()=>{
    try{ await signInWithPopup(auth, provider) }catch(e){ alert(e.message) }
  };
  btnOut.onclick = ()=>signOut(auth);

  let uid=null, curSymbol='‚Ç¨';
  onAuthStateChanged(auth, user=>{
    if(user){
      uid = user.uid;
      btnSign.style.display='none'; btnOut.style.display='inline-block';
      nameInput.value = user.displayName || nameInput.value || '';
      welcomeName.textContent = nameInput.value || 'Friend';
      bindCommitments();
      bindExpenses();
    } else {
      uid=null;
      btnSign.style.display='inline-block'; btnOut.style.display='none';
      $('#c_tbody').innerHTML=''; $('#e_tbody').innerHTML='';
      refreshStats();
    }
  });

  nameInput.oninput = ()=>{ welcomeName.textContent = nameInput.value || 'Friend'; localStorage.setItem('sb_name', nameInput.value) }
  nameInput.value = localStorage.getItem('sb_name') || '';

  // --- Helpers ---
  const fmt = (v)=>`${(currencySel.value||'‚Ç¨')[0]} ${Number(v||0).toFixed(2)}`;
  const daysBetween = (d)=> Math.ceil((new Date(d).setHours(23,59,59,999) - Date.now())/86400000);

  // --- Commitments CRUD ---
  const cRef = ()=>collection(db,'users',uid,'commitments');
  $('#c_add').onclick = async ()=>{
    if(!uid) return alert('Sign in first');
    const name=$('#c_name').value.trim();
    const cat=$('#c_cat').value;
    const amount=Number($('#c_amount').value||0);
    const due=$('#c_due').value;
    if(!name||!amount||!due) return alert('Please fill all fields');
    await addDoc(cRef(), {name,cat,amount,due,paid:false,ts:serverTimestamp()});
    $('#c_name').value=''; $('#c_amount').value=''; showToast('Commitment added');
  };

  function rowStatus(d){
    const days = daysBetween(d.due);
    if(d.paid) return {label:'Paid', cls:'paid'};
    if(days < 0) return {label:'Overdue', cls:'over'};
    if(days <= 3) return {label:'Due soon', cls:'soon'};
    return {label:'Pending', cls:''};
  }

  function bindCommitments(){
    const qy = query(cRef(), orderBy('ts','desc'));
    onSnapshot(qy, snap=>{
      let total=0, paid=0, next = Infinity;
      const tbody = $('#c_tbody'); tbody.innerHTML='';
      snap.forEach(docu=>{
        const d={id:docu.id, ...docu.data()};
        total += Number(d.amount||0);
        if(d.paid) paid++;
        const dv = daysBetween(d.due); if(dv>=0) next = Math.min(next, dv);

        const s = rowStatus(d);
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${d.name}</td>
          <td>${d.cat}</td>
          <td>${fmt(d.amount)}</td>
          <td>${d.due}</td>
          <td><span class="badge ${s.cls}">${s.label}</span></td>
          <td>${d.notes||''}</td>
          <td>
            <button data-act="toggle">‚úî</button>
            <button data-act="del" style="color:#b00">üóë</button>
          </td>`;
        tr.querySelector('[data-act="toggle"]').onclick = ()=>updateDoc(doc(db,'users',uid,'commitments',d.id),{paid:!d.paid});
        tr.querySelector('[data-act="del"]').onclick = ()=>deleteDoc(doc(db,'users',uid,'commitments',d.id));
        tbody.appendChild(tr);
      });
      $('#c_total').textContent = fmt(total);
      $('#c_paid_count').textContent = String(paid);
      $('#c_next_due').textContent = (next===Infinity?'‚Äî':(next+' days'));
      refreshStats(); // recalculates dashboard + bars
      // push visual reminders if permission granted
      scheduleLocalAlertsForUpcoming();
    });
  }

  // --- Expenses CRUD ---
  const eRef = ()=>collection(db,'users',uid,'expenses');
  $('#e_add').onclick = async ()=>{
    if(!uid) return alert('Sign in first');
    const date=$('#e_date').value || new Date().toISOString().slice(0,10);
    const cat=$('#e_cat').value;
    const desc=$('#e_desc').value.trim();
    const amount=Number($('#e_amount').value||0);
    const method=$('#e_method').value;
    if(!amount) return alert('Enter amount');
    await addDoc(eRef(), {date,cat,desc,amount,method,ts:serverTimestamp()});
    $('#e_amount').value=''; $('#e_desc').value='';
    showToast('Expense added');
  };

  function bindExpenses(){
    const qy = query(eRef(), orderBy('ts','desc'));
    onSnapshot(qy, snap=>{
      let total=0; const tbody=$('#e_tbody'); tbody.innerHTML='';
      const catSum = {};
      let firstDay=null, lastDay=null;

      snap.forEach(docu=>{
        const d={id:docu.id, ...docu.data()};
        total += Number(d.amount||0);
        catSum[d.cat]=(catSum[d.cat]||0)+Number(d.amount||0);

        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${d.date||''}</td><td>${d.cat||''}</td><td>${d.desc||''}</td>
          <td>${fmt(d.amount)}</td><td>${d.method||''}</td>
          <td><button data-del>üóë</button></td>`;
        tr.querySelector('[data-del]').onclick = ()=>deleteDoc(doc(db,'users',uid,'expenses',d.id));
        tbody.appendChild(tr);

        const dt=new Date(d.date||Date.now());
        firstDay = firstDay?Math.min(firstDay, dt):dt;
        lastDay  = lastDay?Math.max(lastDay,  dt):dt;
      });

      $('#e_total').textContent = fmt(total);
      const days = firstDay && lastDay ? Math.max(1, Math.ceil((lastDay-firstDay)/86400000)+1) : 1;
      $('#e_avg').textContent = fmt(total/days);

      const top = Object.entries(catSum).sort((a,b)=>b[1]-a[1]).slice(0,3)
        .map(([k,v])=>`${k} ${fmt(v)}`).join(' ¬∑ ') || '‚Äî';
      $('#e_top3').textContent = top;

      refreshStats();
    });
  }

  // --- Dashboard quick stats ---
  function refreshStats(){
    // ŸáŸÜÿß ÿ®ÿ•ŸÖŸÉÿßŸÜŸÉ ÿ•ÿ∂ÿßŸÅÿ© ÿØÿÆŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ±ÿµŸäÿØ ÿ•ŸÜ ÿ±ÿ∫ÿ®ÿ™Ÿê
    const expTxt = $('#e_total').textContent || '‚Ç¨ 0.00';
    $('#statExpenses').textContent = expTxt;
    const paid = Number($('#c_paid_count').textContent||0);
    const tb = $('#c_total').textContent.replace(/[^\d.]/g,'')||'0';
    const total = Number(tb);
    const pct = !total?0:Math.round(paid/paid /* dummy to display count only */);
    const barPct = !total?0:Math.round((paid/Math.max(1, paid + (total>0?1:0)))*100); // simple
    $('#paidBar').style.width = barPct + '%';
    $('#paidPct').textContent = barPct + '%';
    $('#paidCount').textContent = `${paid}/${paid}`;
    $('#statBalance').textContent = '‚Ç¨ 0.00';
  }

  // --- OneSignal (in-page) ---
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: "5dbef29c-1d7a-403d-9399-b2566983cc30",
      safari_web_id: null,
      allowLocalhostAsSecureOrigin: true,
      notifyButton: { enable: false },
    });
  });

  const btnNotif = document.getElementById('btnNotif');
  btnNotif.onclick = async ()=>{
    if(!('OneSignal' in window)) return alert('OneSignal SDK not loaded yet');
    const permission = await OneSignal.User.PushConsent.get();
    await OneSignal.Slidedown.promptPush();
  };

  // ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÖÿ±ÿ¶Ÿäÿ© ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ (ÿ®ÿØŸàŸÜ ÿÆÿßÿØŸÖ)
  async function scheduleLocalAlertsForUpcoming(){
    if(!('OneSignal' in window)) return;
    // ŸÜŸÇÿ±ÿ£ ÿ¨ÿØŸàŸÑ ÿßŸÑÿßŸÑÿ™ÿ≤ÿßŸÖÿßÿ™ ÿßŸÑŸÖÿπÿ±Ÿàÿ∂ÿ© ÿ≠ÿßŸÑŸäŸãÿß ŸàŸÜÿ±ÿ≥ŸÑ ÿ•ÿ¥ÿπÿßÿ± ÿ®ÿ≥Ÿäÿ∑ ÿ•ÿ∞ÿß ‚â§ 3 ÿ£ŸäÿßŸÖ ÿ£Ÿà Overdue
    const rows = [...document.querySelectorAll('#c_tbody tr')].map(tr=>{
      const tds = tr.querySelectorAll('td'); return {
        name: tds[0]?.textContent || '',
        due:  tds[3]?.textContent || '',
        status: tds[4]?.innerText || ''
      };
    });
    const soon = rows.filter(r=>/Due soon|Overdue/i.test(r.status));
    for(const r of soon){
      const title = /Overdue/.test(r.status)? 'Overdue payment' : 'Payment due soon';
      const body  = `${r.name} ‚Äî due ${r.due}`;
      try { await OneSignal.Notifications.create({ contents:{en:body}, headings:{en:title} }) } catch(e){}
    }
  }

  // --- Service Worker registration ---
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('/sw.js').catch(console.warn);
  }
</script>

<!-- OneSignal SDK -->
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
</body>
</html>
