<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Smart Budget & Commitments Dashboard</title>

<!-- PWA manifest + icons -->
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#0f1f39"/>

<!-- Favicon (classic) - files are in the project ROOT -->
<link rel="icon" type="image/png" sizes="16x16"  href="/icon-16.png">
<link rel="icon" type="image/png" sizes="32x32"  href="/icon-32.png">
<link rel="icon" type="image/png" sizes="64x64"   href="/icon-64.png">
<link rel="icon" type="image/png" sizes="128x128" href="/icon-128.png">

<!-- PWA icons -->
<link rel="icon" type="image/png" sizes="180x180" href="/icon-180.png">
<link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
<link rel="icon" type="image/png" sizes="256x256" href="/icon-256.png">
<link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">

<!-- iOS/Apple -->
<link rel="apple-touch-icon" href="/icon-180.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Smart Budget">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap"/>

<style>
:root{
  --bg:#f5f6fa; --card:#fff; --ink:#111827;
  --brand:#3157E0; --muted:#6b7280; --soft:#e8ecf8;
  --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --ring:#d1d5db;
}
[data-theme="dark"]{
  --bg:#0b1220; --card:#111827; --ink:#e5ecff;
  --brand:#6c8bff; --muted:#98a2b3; --soft:#1a2440; --ring:#2a3347;
}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
.wrap{max-width:1160px;margin:0 auto;padding:16px}
header{display:flex;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap}
.logo{width:36px;height:36px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.12)}
.title{font-weight:800;font-size:28px}
.row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;background:var(--card);border:1px solid var(--ring)}
input,select,button,textarea{font:inherit}
input,select,textarea{height:40px;padding:8px 10px;border-radius:12px;border:1px solid var(--ring);background:var(--card);color:var(--ink)}
textarea{height:auto;min-height:110px;resize:vertical}
button{height:42px;padding:10px 14px;border-radius:14px;border:0;background:var(--brand);color:#fff;font-weight:700;cursor:pointer;box-shadow:0 8px 24px rgba(49,87,224,.25)}
button.ghost{background:var(--card);color:var(--ink);border:1px solid var(--ring);box-shadow:none}
nav{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0 16px}
nav button{background:#e8efff;color:#0f2a7a;border:0}
nav button.active{background:var(--brand);color:#fff}
.card{background:var(--card);border:1px solid var(--ring);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:16px}
.h2{font-size:20px;font-weight:800;margin:4px 0 12px}
.grid{display:grid;gap:12px}
.grid-2{grid-template-columns:1fr 1fr}
.grid-3{grid-template-columns:repeat(3,1fr)}
@media(max-width:980px){.grid-2,.grid-3{grid-template-columns:1fr}}
.kpi{display:grid;gap:8px}
.kpi .big{font-size:30px;font-weight:800}
blockquote{margin:0;padding:12px;border-radius:12px;background:#eef4ff;border:1px dashed #cfd9ff;color:#0f2a7a}
.muted{color:var(--muted)} .right{margin-left:auto}
table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid var(--ring);vertical-align:top}
.pill{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:700;font-size:12px}
.paid{background:#dcfce7;color:#166534} .soon{background:#fff7ed;color:#9a3412} .over{background:#fee2e2;color:#991b1b} .pend{background:#e5edff;color:#1e3a8a}
.progress{height:12px;background:#edf1fb;border-radius:999px;overflow:hidden} .progress>i{display:block;height:100%;background:var(--brand);width:0}
.small{font-size:12px}
.badge{padding:4px 8px;border-radius:8px;border:1px solid var(--ring);background:var(--card)}
.sep{height:1px;background:var(--ring);margin:8px 0}
ul.clean{margin:0;padding-left:18px}
</style>
</head>
<body>
<div class="wrap" id="app">

  <!-- Header -->
  <header class="row">
    <img src="/icon-192.png" class="logo" alt="logo">
    <div class="title">Smart Budget & Commitments</div>
    <span class="right"></span>
    <button class="ghost" id="btn-theme">üåô/‚òÄÔ∏è</button>
  </header>

  <!-- Quick prefs -->
  <div class="row">
    <input id="userName" class="chip" placeholder="Your name"/>
    <select id="currency" class="chip">
      <option>‚Ç¨ EUR</option><option>$ USD</option><option>¬£ GBP</option><option>SAR</option>
    </select>
    <select id="accent" class="chip"><option>Blue</option><option>Sage</option><option>Sand</option></select>
    <button id="btnGoogle" class="chip" style="background:#f5c26b;color:#3a2a00">Sign in with Google</button>
    <button id="btnNotify" class="chip">Enable Notifications üîî</button>
    <button id="btnLogout" class="chip ghost" style="display:none">Logout</button>
  </div>

  <!-- Nav (9 tabs) -->
  <nav id="tabs">
    <button data-tab="dash" class="active">Dashboard</button>
    <button data-tab="budget">Budget</button>
    <button data-tab="expense">Expenses</button>
    <button data-tab="savings">Savings</button>
    <button data-tab="payments">Payments</button>
    <button data-tab="commit">Commitments</button>
    <button data-tab="analysis">Analysis</button>
    <button data-tab="events">Events</button>
    <button data-tab="notes">Notes</button>
  </nav>

  <!-- ===== DASHBOARD ===== -->
  <section id="tab-dash" class="grid grid-2">
    <div class="card">
      <div class="h2" id="welcome">Welcome, Guest üëã</div>
      <blockquote>‚ÄúTrack your money. Master your life.‚Äù</blockquote>
      <div class="grid grid-3" style="margin-top:10px">
        <div class="card kpi"><div class="muted small">Total Balance</div><div class="big" id="kpi-balance">‚Ç¨ 0.00</div></div>
        <div class="card kpi"><div class="muted small">Total Expenses (month)</div><div class="big" id="kpi-exp">‚Ç¨ 0.00</div></div>
        <div class="card kpi">
          <div class="row"><div class="muted small">% Commitments Paid</div><div class="right small" id="kpi-paid-count">0/0</div></div>
          <div class="progress"><i id="kpi-paid"></i></div>
        </div>
      </div>
      <div class="card" style="margin-top:10px">
        <div class="row"><div><b>Next Event</b></div><div class="right muted small" id="kpi-next-event">‚Äî</div></div>
        <div class="row"><div><b>Next Due</b></div><div class="right muted small" id="kpi-next-due">‚Äî</div></div>
      </div>
    </div>
    <div class="card">
      <div class="h2">This Month Snapshot</div>
      <div class="row">
        <span class="badge">Top categories: <b id="dash-top3">‚Äî</b></span>
        <span class="badge">Daily avg: <b id="dash-daily">‚Äî</b></span>
      </div>
      <div class="sep"></div>
      <div class="small muted">Recent expenses</div>
      <ul id="dash-recent" class="clean small muted"></ul>
    </div>
  </section>

  <!-- ===== BUDGET ===== -->
  <section id="tab-budget" class="grid">
    <div class="card">
      <div class="h2">Monthly Budget</div>
      <div class="row">
        <input id="b_item" placeholder="Item (e.g. Salary / Rent)"/>
        <select id="b_type"><option value="income">Income</option><option value="fixed">Fixed</option><option value="variable">Variable</option></select>
        <input id="b_amt" type="number" step="0.01" placeholder="Amount"/>
        <button id="btnAddB">+ Add</button>
      </div>
    </div>
    <div class="card">
      <div class="row"><div class="h2" style="margin:0">Items</div><div class="right muted">Totals: <span id="b_totals">‚Äî</span></div></div>
      <table id="b_table"><thead><tr><th>Item</th><th>Type</th><th>Amount</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <!-- ===== EXPENSES ===== -->
  <section id="tab-expense" class="grid">
    <div class="card">
      <div class="h2">Expenses</div>
      <div class="row">
        <input id="e_date" type="date" style="width:160px">
        <select id="e_cat" style="width:250px"></select>
        <input id="e_desc" placeholder="Description" style="flex:1">
        <input id="e_amt" type="number" step="0.01" placeholder="Amount" style="width:160px">
        <select id="e_method" style="width:140px"><option>Card</option><option>Cash</option><option>Transfer</option><option>Other</option></select>
        <button id="btnAddE">+ Add</button>
      </div>
    </div>
    <div class="card">
      <div class="row"><div class="h2" style="margin:0">History</div><div class="right muted">Total: <span id="e_total">0.00</span></div></div>
      <table id="e_table"><thead><tr><th>Date</th><th>Category</th><th>Description</th><th>Amount</th><th>Method</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <!-- ===== SAVINGS ===== -->
  <section id="tab-savings" class="grid">
    <div class="card">
      <div class="h2">Saving Plans</div>
      <div class="row">
        <input id="s_name" placeholder="Goal name (Vacation‚Ä¶)" style="flex:2">
        <select id="s_cat"><option>Vacation</option><option>Wedding</option><option>Investment</option><option>Other</option></select>
        <input id="s_target" type="number" step="0.01" placeholder="Target">
        <input id="s_months" type="number" step="1" placeholder="Months">
      </div>
      <div class="row" style="margin-top:8px">
        <input id="s_start" type="date">
        <input id="s_end" type="date" readonly>
        <label class="chip"><input type="checkbox" id="s_toCommit" style="margin-right:8px" checked>Add to Commitments</label>
        <button id="btnAddS">+ Add Plan</button>
      </div>
    </div>
    <div class="card">
      <div class="row"><div class="h2" style="margin:0">Plans</div><div class="right muted">Total progress: <span id="s_total_prog">0%</span></div></div>
      <table id="s_table"><thead><tr><th>Goal</th><th>Category</th><th>Target</th><th>Months</th><th>Monthly</th><th>Start</th><th>End</th><th>Progress</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <!-- ===== PAYMENTS (logs) ===== -->
  <section id="tab-payments" class="grid">
    <div class="card">
      <div class="h2">Payments</div>
      <div class="row">
        <select id="p_type"><option>Commitment</option><option>Expense</option><option>Saving</option></select>
        <input id="p_ref" placeholder="Reference (e.g. Rent June)">
        <input id="p_amt" type="number" step="0.01" placeholder="Amount">
        <input id="p_date" type="date">
        <button id="btnAddP">+ Log Payment</button>
      </div>
    </div>
    <div class="card">
      <div class="row"><div class="h2" style="margin:0">History</div></div>
      <table id="p_table"><thead><tr><th>Date</th><th>Type</th><th>Reference</th><th>Amount</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <!-- ===== COMMITMENTS ===== -->
  <section id="tab-commit" class="grid">
    <div class="card">
      <div class="h2">Commitments (Fixed)</div>
      <div class="row">
        <input id="c_name" placeholder="Commitment name" style="flex:2">
        <select id="c_cat" style="width:260px"></select>
        <input id="c_amount" type="number" step="0.01" placeholder="Monthly">
        <input id="c_due" type="date">
        <button id="btnAddC">+ Add</button>
      </div>
      <div class="row" style="margin-top:8px">
        <label class="chip"><input type="checkbox" id="c_remind" checked style="margin-right:8px">Auto-remind</label>
        <select id="c_remindWhen" class="chip"><option value="30">30 days</option><option value="7">7 days</option><option value="3">3 days</option><option value="1">1 day</option></select>
      </div>
    </div>
    <div class="card">
      <div class="row"><div class="h2" style="margin:0">List</div><div class="right muted">Total: <span id="c_total">0.00</span></div></div>
      <table id="c_table"><thead><tr><th>Name</th><th>Category</th><th>Monthly</th><th>Due</th><th>Status</th><th>Reminder</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <!-- ===== ANALYSIS ===== -->
  <section id="tab-analysis" class="grid">
    <div class="card">
      <div class="h2">Spending Analysis</div>
      <div class="row">
        <span class="badge">Expenses this month: <b id="a_month_total">‚Äî</b></span>
        <span class="badge">Top category: <b id="a_top">‚Äî</b></span>
        <span class="badge">Transactions: <b id="a_tx">0</b></span>
      </div>
      <div class="sep"></div>
      <div class="small muted">Helper formulas (Google Sheets):</div>
      <ul class="small muted clean">
        <li>Days to Event: <code>= [Event_Date]-TODAY()</code></li>
        <li>Months to Save: <code>=DATEDIF([Start_Date],[End_Date],"M")+1</code></li>
        <li>Monthly Contr.: <code>=ROUNDUP([Target]/[Months],2)</code></li>
        <li>Status: <code>=IF(Paid>=Amount,"Paid",IF(Due<TODAY(),"Overdue",IF(Due-TODAY()<=3,"Due Soon","Pending")))</code></li>
      </ul>
    </div>
  </section>

  <!-- ===== EVENTS ===== -->
  <section id="tab-events" class="grid">
    <div class="card">
      <div class="h2">Events & Gifts</div>
      <div class="row">
        <input id="ev_name" placeholder="Event (e.g. Mom's Birthday)" style="flex:2">
        <select id="ev_type"><option>Birthday</option><option>Anniversary</option><option>Holiday</option><option>Gift</option><option>Other</option></select>
        <input id="ev_date" type="date">
        <input id="ev_amt" type="number" step="0.01" placeholder="Planned spend">
      </div>
      <div class="row" style="margin-top:8px">
        <label class="chip"><input type="checkbox" id="ev_toCommit" style="margin-right:8px">Add to Commitments</label>
        <textarea id="ev_notes" placeholder="Notes‚Ä¶" style="flex:1"></textarea>
        <button id="btnAddEV">+ Add Event</button>
      </div>
    </div>
    <div class="card">
      <div class="row"><div class="h2" style="margin:0">Planner</div><div class="right muted">Next in: <span id="ev_next">‚Äî</span> | Gifts budget: <span id="ev_gifts">0.00</span></div></div>
      <table id="ev_table"><thead><tr><th>Event</th><th>Type</th><th>Date</th><th>Planned</th><th>Reminder</th><th>Notes</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <!-- ===== NOTES ===== -->
  <section id="tab-notes" class="grid">
    <div class="card">
      <div class="h2">Notes & Motivation</div>
      <blockquote>‚ÄúTrack your money. Reach your goals.‚Äù</blockquote>
      <textarea id="notes" placeholder="Write your financial goals, plans, and notes here‚Ä¶"></textarea>
      <div class="row" style="margin-top:8px"><button id="btnSaveNotes">Save Notes</button><span class="muted small">Saved to your account.</span></div>
    </div>
  </section>

</div>

<!-- OneSignal SDK -->
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

<!-- Firebase (modular v10) + App logic -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ===== Firebase config ===== */
const firebaseConfig = {
  apiKey: "AIzaSyCfnCTuunR_E15GQaPQyUbS2Fdj6XAYfUo",
  authDomain: "smart-budget-61664.firebaseapp.com",
  projectId: "smart-budget-61664",
  storageBucket: "smart-budget-61664.appspot.com",
  messagingSenderId: "273780649075",
  appId: "1:273780649075:web:c0c08d6d56f5085e9e0e06"
};

const appFB = initializeApp(firebaseConfig);
const auth = getAuth(appFB);
const db = getFirestore(appFB);
const provider = new GoogleAuthProvider();

/* ===== OneSignal ===== */
window.OneSignalDeferred = window.OneSignalDeferred || [];
OneSignalDeferred.push(async function(OneSignal) {
  await OneSignal.init({
    appId: "5dbef29c-1d7a-403d-9399-b2566983cc30",
    allowLocalhostAsSecureOrigin: true
  });
});

/* ===== Helpers/UI ===== */
const $ = s => document.querySelector(s);
const byId = id => document.getElementById(id);
const setText = (id,t)=>{ const el=byId(id); if(el) el.textContent = t; };
const fmt = (v)=> (byId('currency').value.split(' ')[0] || '‚Ç¨') + ' ' + Number(v||0).toFixed(2);
const todayISO = ()=> new Date().toISOString().slice(0,10);

/* ===== Theme toggle ===== */
const btnTheme = byId('btn-theme');
const savedTheme = localStorage.getItem('sb_theme') || 'light';
if(savedTheme==='dark') document.documentElement.setAttribute('data-theme','dark');
btnTheme.onclick = ()=>{
  const dark = document.documentElement.getAttribute('data-theme')==='dark';
  document.documentElement.setAttribute('data-theme', dark?'':'dark');
  localStorage.setItem('sb_theme', dark?'light':'dark');
};

/* ===== Tabs ===== */
document.querySelectorAll('nav button').forEach(b=>{
  b.onclick = ()=>{
    document.querySelectorAll('nav button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    document.querySelectorAll('section[id^="tab-"]').forEach(sec=>sec.style.display='none');
    byId('tab-'+b.dataset.tab).style.display = 'grid';
  };
});

/* ===== Full categories ===== */
const FULL_CATEGORIES = [
  "Groceries","Coffee & Snacks","Dining Out","Household Supplies","Fuel / Gas","Public Transport","Car Maintenance",
  "Rent / Mortgage","Electricity","Water","Internet & Phone","Home Maintenance","Healthcare / Medicine","Insurance",
  "Gym / Fitness","Personal Care","Clothing & Accessories","Gifts & Celebrations","Entertainment","Hobbies & Subscriptions",
  "Courses & Learning","Books & Materials","Work Expenses","Software & Apps","Savings / Investments",
  "Travel","Accommodation","Activities & Tickets","Donations & Charity","Taxes & Fees","Miscellaneous"
];
function fillSelect(sel, items){ sel.innerHTML = items.map(x=>`<option>${x}</option>`).join(''); }
fillSelect(byId('e_cat'), FULL_CATEGORIES);
fillSelect(byId('c_cat'), FULL_CATEGORIES);

/* ===== Inputs & buttons ===== */
const nameEl=byId('userName'), currencyEl=byId('currency'), accentEl=byId('accent');
const btnGoogle=byId('btnGoogle'), btnLogout=byId('btnLogout'), btnNotify=byId('btnNotify');

/* ===== Local prefs ===== */
nameEl.value = localStorage.getItem('sb_name') || '';
currencyEl.value = localStorage.getItem('sb_cur') || '‚Ç¨ EUR';
accentEl.value = localStorage.getItem('sb_accent') || 'Blue';
[nameEl,currencyEl,accentEl].forEach(el=> el.onchange = ()=> {
  localStorage.setItem('sb_name', nameEl.value);
  localStorage.setItem('sb_cur', currencyEl.value);
  localStorage.setItem('sb_accent', accentEl.value);
  renderAll();
  if(uid) savePrefs();
});

/* ===== SW register + notifications ===== */
if('serviceWorker' in navigator){ navigator.serviceWorker.register('/sw.js'); }
btnNotify.onclick = async ()=>{
  try{
    const perm = await Notification.requestPermission();
    if(perm!=='granted') alert('Notifications are blocked.');
  }catch(e){ console.error(e); }
};

/* ===== Auth ===== */
btnGoogle.onclick = async ()=>{
  try{ await signInWithPopup(auth, provider); }
  catch(e){ alert('Google sign-in blocked (pop-ups?).'); console.error(e); }
};
btnLogout.onclick = ()=> signOut(auth);

/* ===== Firestore state ===== */
let uid=null, userDocRef=null, userData=null;
async function savePrefs(){ await updateDoc(userDocRef, { prefs:{ name:nameEl.value, currency:currencyEl.value, accent:accentEl.value } }); }

/* ===== Helpers ===== */
function daysUntil(dateISO){ return Math.ceil((new Date(dateISO).getTime()-Date.now())/86400000); }
function statusFromDue(dueISO, status){
  if(status==='Paid') return 'Paid';
  if(!dueISO) return 'Pending';
  const d=daysUntil(dueISO);
  if(d<0) return 'Overdue';
  if(d<=3) return 'Due soon';
  return 'Pending';
}
function pillClass(s){ return s==='Paid'?'paid': s==='Overdue'?'over': s==='Due soon'?'soon':'pend'; }
function scheduleLocalReminder(payload){
  if(!navigator.serviceWorker.controller) return;
  navigator.serviceWorker.controller.postMessage({type:'schedule', payload});
}

/* ===== Renderers (KPIs) ===== */
function renderKPIs(){
  const name = nameEl.value || 'Guest';
  setText('welcome', `Welcome, ${name} üëã`);

  const exps = userData?.expenses || [];
  const cmt  = userData?.commitments || [];
  const bud  = userData?.budget || [];

  const income = bud.filter(x=>x.type==='income').reduce((a,x)=>a+Number(x.amount||0),0);
  const fixed  = bud.filter(x=>x.type!=='income').reduce((a,x)=>a+Number(x.amount||0),0);
  const expTot = exps.reduce((a,x)=>a+Number(x.amount||0),0);
  setText('kpi-balance', fmt(income - (expTot + fixed)));
  setText('kpi-exp', fmt(expTot));

  const paid = cmt.filter(x=>x.status==='Paid').length;
  setText('kpi-paid-count', `${paid}/${cmt.length}`);
  byId('kpi-paid').style.width = (cmt.length? Math.round(paid*100/cmt.length):0)+'%';

  const upcoming = cmt.filter(x=>x.status!=='Paid' && x.due).map(x=>({name:x.name,days:daysUntil(x.due)})).sort((a,b)=>a.days-b.days)[0];
  setText('kpi-next-due', upcoming? `${upcoming.days} day(s) ‚Äî ${upcoming.name}` : '‚Äî');

  const evs = userData?.events || [];
  const now = new Date();
  const nextEv = evs.map(x=>({name:x.eventName,date:new Date(x.eventDate)})).filter(x=>x.date>=now).map(x=>({name:x.name,days:Math.ceil((x.date-now)/86400000)})).sort((a,b)=>a.days-b.days)[0];
  setText('kpi-next-event', nextEv? `${nextEv.days} day(s) ‚Äî ${nextEv.name}` : '‚Äî');

  const perCat = {};
  exps.forEach(e=> perCat[e.category]=(perCat[e.category]||0)+Number(e.amount||0));
  const top = Object.entries(perCat).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([k])=>k).join(', ') || '‚Äî';
  setText('dash-top3', top);
  setText('dash-daily', fmt(expTot/30));
  byId('dash-recent').innerHTML = exps.slice(-6).reverse().map(e=>`<li>${e.date} ‚Äî ${e.category}: ${fmt(e.amount)} (${e.method})</li>`).join('');
}

/* ===== Tables ===== */
function redrawBudget(){
  const tbody = byId('b_table').querySelector('tbody'); const items = userData?.budget||[];
  tbody.innerHTML = items.map(x=>`<tr><td>${x.item}</td><td>${x.type}</td><td>${fmt(x.amount)}</td><td><button class="ghost" data-bid="${x.id}">Delete</button></td></tr>`).join('');
  tbody.querySelectorAll('button[data-bid]').forEach(b=> b.onclick = ()=> delRow('budget', b.dataset.bid));
  const inc=items.filter(i=>i.type==='income').reduce((a,x)=>a+Number(x.amount||0),0);
  const fix=items.filter(i=>i.type==='fixed').reduce((a,x)=>a+Number(x.amount||0),0);
  const varb=items.filter(i=>i.type==='variable').reduce((a,x)=>a+Number(x.amount||0),0);
  setText('b_totals', `Income ${fmt(inc)} ‚Ä¢ Fixed ${fmt(fix)} ‚Ä¢ Variable ${fmt(varb)}`);
}
function redrawExpenses(){
  const tbody = byId('e_table').querySelector('tbody'); const exps = userData?.expenses||[];
  tbody.innerHTML = exps.slice().reverse().map(e=>`<tr>
    <td>${e.date}</td><td>${e.category}</td><td>${e.description||''}</td>
    <td>${fmt(e.amount)}</td><td>${e.method}</td>
    <td><button class="ghost" data-id="${e.id}" data-type="expense">Delete</button></td>
  </tr>`).join('');
  tbody.querySelectorAll('button[data-type="expense"]').forEach(b=> b.onclick=()=>delRow('expenses', b.dataset.id));
  setText('e_total', exps.reduce((a,x)=>a+Number(x.amount||0),0).toFixed(2));
}
function redrawCommitments(){
  const tbody = byId('c_table').querySelector('tbody'); const cs = userData?.commitments||[];
  tbody.innerHTML = cs.map(c=>{
    const s = statusFromDue(c.due,c.status);
    return `<tr>
      <td>${c.name}</td><td>${c.category}</td><td>${fmt(c.amount)}</td><td>${c.due||''}</td>
      <td><span class="pill ${pillClass(s)}">${s}</span></td>
      <td>${c.remind?`üîî ${c.remindDays}d before`:''}</td>
      <td>
        <button class="ghost" data-act="paid" data-id="${c.id}">Mark paid</button>
        <button class="ghost" data-act="del" data-id="${c.id}">Delete</button>
      </td>
    </tr>`;
  }).join('');
  tbody.querySelectorAll('button').forEach(b=> b.onclick=()=> rowActionCommit(b.dataset.act,b.dataset.id));
  setText('c_total', (userData?.commitments||[]).reduce((a,x)=>a+Number(x.amount||0),0).toFixed(2));
}
function redrawSavings(){
  const tbody = byId('s_table').querySelector('tbody'); const ss = userData?.savings||[];
  tbody.innerHTML = ss.map(s=>{
    const prog = Math.min(Math.round((s.saved||0)*100/Number(s.target||1)),100);
    return `<tr>
      <td>${s.name}</td><td>${s.category}</td><td>${fmt(s.target)}</td>
      <td>${s.months}</td><td>${fmt(s.monthly)}</td><td>${s.start}</td><td>${s.end}</td>
      <td><div class="progress"><i style="width:${prog}%"></i></div><div class="small muted">${prog}%</div></td>
      <td><button class="ghost" data-id="${s.id}">Delete</button></td>
    </tr>`;
  }).join('');
  tbody.querySelectorAll('button').forEach(b=> b.onclick = ()=> delRow('savings', b.dataset.id));
  const totalProg = ss.length? Math.round((ss.reduce((a,x)=>a+(x.saved||0),0)/ss.reduce((a,x)=>a+Number(x.target||0),0))*100):0;
  setText('s_total_prog', (isFinite(totalProg)?totalProg:0)+'%');
}
function redrawPayments(){
  const tbody = byId('p_table').querySelector('tbody'); const ps = userData?.payments||[];
  tbody.innerHTML = ps.slice().reverse().map(p=>`<tr>
    <td>${p.date}</td><td>${p.type}</td><td>${p.ref}</td><td>${fmt(p.amount)}</td>
    <td><button class="ghost" data-id="${p.id}">Delete</button></td>
  </tr>`).join('');
  tbody.querySelectorAll('button').forEach(b=> b.onclick=()=> delRow('payments', b.dataset.id));
}
function redrawEvents(){
  const tbody = byId('ev_table').querySelector('tbody'); const evs = userData?.events||[];
  let giftsTotal=0, nextDays=null;
  tbody.innerHTML = evs.map(e=>{
    giftsTotal += Number(e.planned||0);
    const diff = Math.ceil((new Date(e.eventDate)-Date.now())/86400000);
    if(diff>=0 && (nextDays===null || diff<nextDays)) nextDays=diff;
    let cls='pend', txt='‚Äî'; 
    if(diff<0){ cls=''; txt='‚ö™ Past'; }
    else if(diff<=3){ cls='over'; txt='üî¥ 3 days'; }
    else if(diff<=7){ cls='soon'; txt='üü† 1 week'; }
    else if(diff<=30){ cls='pend'; txt='üíô 1 month'; }
    else { cls='pend'; txt=diff+' days'; }
    return `<tr>
      <td>${e.eventName}</td><td>${e.eventType}</td><td>${e.eventDate}</td><td>${fmt(e.planned||0)}</td>
      <td><span class="pill ${cls}">${txt}</span></td><td>${e.notes||''}</td>
      <td><button class="ghost" data-id="${e.id}">Delete</button></td>
    </tr>`;
  }).join('');
  tbody.querySelectorAll('button').forEach(b=> b.onclick=()=> delRow('events', b.dataset.id));
  setText('ev_gifts', (giftsTotal||0).toFixed(2));
  setText('ev_next', nextDays===null?'‚Äî':`${nextDays} day(s)`);
}

/* ===== Analysis ===== */
function renderAnalysis(){
  const exps = userData?.expenses||[];
  setText('a_month_total', fmt(exps.reduce((a,x)=>a+Number(x.amount||0),0)));
  setText('a_tx', exps.length);
  const perCat={}; exps.forEach(e=> perCat[e.category]=(perCat[e.category]||0)+Number(e.amount||0));
  const top = Object.entries(perCat).sort((a,b)=>b[1]-a[1])[0]?.[0] || '‚Äî';
  setText('a_top', top);
}

/* ===== Glue render ===== */
function renderAll(){ renderKPIs(); redrawBudget(); redrawExpenses(); redrawCommitments(); redrawSavings(); redrawPayments(); redrawEvents(); renderAnalysis(); }

/* ===== Add handlers ===== */
byId('btnAddB').onclick = async ()=>{
  if(!uid) return alert('Sign in first.');
  const item = { id:crypto.randomUUID(), item:byId('b_item').value, type:byId('b_type').value, amount:Number(byId('b_amt').value||0) };
  if(!item.item || !item.amount) return alert('Enter item & amount');
  await updateArray('budget', item);
  byId('b_item').value=''; byId('b_amt').value='';
};
byId('btnAddE').onclick = async ()=>{
  if(!uid) return alert('Sign in first.');
  const it = { id:crypto.randomUUID(), date:byId('e_date').value||todayISO(), category:byId('e_cat').value, description:byId('e_desc').value||'', amount:Number(byId('e_amt').value||0), method:byId('e_method').value };
  if(!it.amount) return alert('Amount?');
  await updateArray('expenses', it); byId('e_desc').value=''; byId('e_amt').value='';
};
byId('btnAddC').onclick = async ()=>{
  if(!uid) return alert('Sign in first.');
  const it = { id:crypto.randomUUID(), name:byId('c_name').value, category:byId('c_cat').value, amount:Number(byId('c_amount').value||0), due:byId('c_due').value, status:"Pending", remind:byId('c_remind').checked, remindDays:Number(byId('c_remindWhen').value) };
  if(!it.name || !it.amount || !it.due) return alert('Enter name, amount, due');
  await updateArray('commitments', it);
  if(it.remind){
    const when = new Date(it.due); when.setDate(when.getDate()-it.remindDays);
    scheduleLocalReminder({ id:it.id, title:'Commitment Reminder', body:`${it.name} due ${it.due} (${fmt(it.amount)})`, fireAt:when.getTime() });
  }
  byId('c_name').value=''; byId('c_amount').value=''; byId('c_due').value='';
};
byId('btnAddS').onclick = async ()=>{
  if(!uid) return alert('Sign in first.');
  const name=byId('s_name').value, cat=byId('s_cat').value, target=Number(byId('s_target').value||0), months=Number(byId('s_months').value||0);
  if(!name||!target||!months) return alert('Fill goal, target, months');
  const start=byId('s_start').value||todayISO(); const end = (d=>{d.setMonth(d.getMonth()+months);return d.toISOString().slice(0,10)})(new Date(start));
  byId('s_end').value=end;
  const monthly = target/months;
  const it = { id:crypto.randomUUID(), name, category:cat, target, months, monthly, start, end, saved:0 };
  await updateArray('savings', it);
  if(byId('s_toCommit').checked){
    await updateArray('commitments', { id:crypto.randomUUID(), name:`Saving ‚Äì ${name}`, category:'Savings / Investments', amount:monthly, due:start, status:'Pending', remind:true, remindDays:7 });
  }
  byId('s_name').value=''; byId('s_target').value=''; byId('s_months').value='';
};
byId('btnAddP').onclick = async ()=>{
  if(!uid) return alert('Sign in first.');
  const it = { id:crypto.randomUUID(), type:byId('p_type').value, ref:byId('p_ref').value, amount:Number(byId('p_amt').value||0), date:byId('p_date').value||todayISO() };
  if(!it.amount || !it.ref) return alert('Ref & amount required');
  await updateArray('payments', it); byId('p_ref').value=''; byId('p_amt').value='';
};
byId('btnAddEV').onclick = async ()=>{
  if(!uid) return alert('Sign in first.');
  const name=byId('ev_name').value, type=byId('ev_type').value, date=byId('ev_date').value, planned=Number(byId('ev_amt').value||0), notes=byId('ev_notes').value||'';
  if(!name||!date) return alert('Event name & date required');
  const it = { id:crypto.randomUUID(), eventName:name, eventType:type, eventDate:date, planned, notes };
  await updateArray('events', it);
  if(byId('ev_toCommit').checked && planned>0){
    await updateArray('commitments', { id:crypto.randomUUID(), name:`Gift ‚Äì ${name}`, category:'Gifts & Celebrations', amount:planned, due:date, status:'Pending', remind:true, remindDays:7 });
  }
  byId('ev_name').value=''; byId('ev_amt').value=''; byId('ev_notes').value='';
};
byId('btnSaveNotes').onclick = async ()=>{
  if(!uid) return alert('Sign in first.');
  await updateDoc(userDocRef, { notes: byId('notes').value||'' });
  alert('Notes saved.');
};

/* ===== Row helpers ===== */
async function rowActionCommit(act,id){
  if(act==='paid'){
    const list = (userData.commitments||[]).map(x=> x.id===id? {...x, status:'Paid'}:x );
    await updateDoc(userDocRef,{ commitments:list });
  } else if(act==='del'){ await delRow('commitments', id); }
}
async function delRow(collectionKey, id){
  const list = (userData[collectionKey]||[]).filter(x=>x.id!==id);
  await updateDoc(userDocRef, { [collectionKey]: list });
}
async function updateArray(key, item){
  const docSnap = await getDoc(userDocRef);
  if(!docSnap.exists()) await setDoc(userDocRef, { prefs:{ name:nameEl.value, currency:currencyEl.value, accent:accentEl.value } });
  await updateDoc(userDocRef, { [key]: arrayUnion(item) });
}

/* ===== Auto calc saving end ===== */
byId('s_start').addEventListener('change', ()=>{
  const months = Number(byId('s_months').value||0); if(!months) return;
  const s = new Date(byId('s_start').value); s.setMonth(s.getMonth()+months); byId('s_end').value = s.toISOString().slice(0,10);
});

/* ===== Auth listener ===== */
onAuthStateChanged(auth, async (user)=>{
  if(user){
    uid = user.uid;
    btnGoogle.style.display='none'; btnLogout.style.display='';
    userDocRef = doc(db,'users',uid);
    const snap = await getDoc(userDocRef);
    if(!snap.exists()){
      await setDoc(userDocRef, { prefs:{ name:nameEl.value, currency:currencyEl.value, accent:accentEl.value }, budget:[], expenses:[], commitments:[], savings:[], payments:[], events:[], notes:'' });
    }
    onSnapshot(userDocRef,(s)=>{
      userData = s.data() || {};
      const p = userData.prefs||{};
      nameEl.value = p.name || nameEl.value; currencyEl.value = p.currency || currencyEl.value; accentEl.value = p.accent || accentEl.value;
      byId('notes').value = userData.notes || '';
      renderAll();
    });
  }else{
    uid=null; userData=null;
    btnGoogle.style.display=''; btnLogout.style.display='none';
    renderAll();
  }
});

/* ===== Initial show ===== */
document.querySelectorAll('section[id^="tab-"]').forEach((s,i)=> s.style.display = i? 'none':'grid');
renderAll();
</script>
</body>
</html>
