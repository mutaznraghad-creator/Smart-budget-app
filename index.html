<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Smart Budget & Commitments Dashboard</title>

<!-- PWA manifest + icons (ÿ¨ÿ∞ÿ± ÿßŸÑŸÖŸàŸÇÿπ) -->
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#0f1f39"/>
<link rel="icon" type="image/png" sizes="16x16" href="/icon-16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/icon-32.png">
<link rel="icon" type="image/png" sizes="64x64" href="/icon-64.png">
<link rel="icon" type="image/png" sizes="128x128" href="/icon-128.png">
<link rel="icon" type="image/png" sizes="180x180" href="/icon-180.png">
<link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
<link rel="icon" type="image/png" sizes="256x256" href="/icon-256.png">
<link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
<link rel="apple-touch-icon" href="/icon-192.png">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Smart Budget">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap"/>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

<style>
:root{
  --bg:#f5f6fa; --card:#fff; --ink:#111827;
  --brand:#3157E0; --muted:#6b7280; --soft:#e8ecf8;
  --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --ring:#d1d5db;
}
[data-theme="dark"]{
  --bg:#0b1220; --card:#111827; --ink:#e5ecff;
  --brand:#6c8bff; --muted:#98a2b3; --soft:#1a2440; --ring:#2a3347;
}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
.wrap{max-width:1160px;margin:0 auto;padding:16px}
header{display:flex;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap}
.logo{width:36px;height:36px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.12)}
.title{font-weight:800;font-size:28px}
.row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;background:var(--card);border:1px solid var(--ring)}
input,select,button,textarea{font:inherit}
input,select,textarea{height:40px;padding:8px 10px;border-radius:12px;border:1px solid var(--ring);background:var(--card);color:var(--ink)}
textarea{height:auto;min-height:110px;resize:vertical}
button{height:42px;padding:10px 14px;border-radius:14px;border:0;background:var(--brand);color:#fff;font-weight:700;cursor:pointer;box-shadow:0 8px 24px rgba(49,87,224,.25)}
button.ghost{background:var(--card);color:var(--ink);border:1px solid var(--ring);box-shadow:none}
nav{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0 16px}
nav button{background:#e8efff;color:#0f2a7a;border:0}
nav button.active{background:var(--brand);color:#fff}
.card{background:var(--card);border:1px solid var(--ring);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:16px}
.h2{font-size:20px;font-weight:800;margin:4px 0 12px}
.grid{display:grid;gap:12px}
.grid-2{grid-template-columns:1fr 1fr}
.grid-3{grid-template-columns:repeat(3,1fr)}
.grid-4{grid-template-columns:repeat(4,1fr)}
@media(max-width:980px){.grid-2,.grid-3,.grid-4{grid-template-columns:1fr}}
.kpi{display:grid;gap:8px}
.kpi .big{font-size:30px;font-weight:800}
blockquote{margin:0;padding:12px;border-radius:12px;background:#eef4ff;border:1px dashed #cfd9ff;color:#0f2a7a}
.muted{color:var(--muted)} .right{margin-left:auto}
table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid var(--ring);vertical-align:top}
.pill{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:700;font-size:12px}
.paid{background:#dcfce7;color:#166534} .soon{background:#fff7ed;color:#9a3412} .over{background:#fee2e2;color:#991b1b} .pend{background:#e5edff;color:#1e3a8a}
.progress{height:12px;background:#edf1fb;border-radius:999px;overflow:hidden} .progress>i{display:block;height:100%;background:var(--brand);width:0}
.small{font-size:12px}
.badge{padding:4px 8px;border-radius:8px;border:1px solid var(--ring);background:var(--card)}
.sep{height:1px;background:var(--ring);margin:8px 0}
ul.clean{margin:0;padding-left:18px}
canvas{width:100%;height:220px}
canvas.mini{height:160px}
.insight{background:var(--card);border:1px dashed var(--ring);padding:10px;border-radius:12px}
</style>
</head>
<body>
<div class="wrap" id="app">

  <!-- Header -->
  <header class="row">
    <img src="/icon-192.png" class="logo" alt="logo">
    <div class="title">Smart Budget & Commitments</div>
    <span class="right"></span>
    <button class="ghost" id="btn-theme">üåô/‚òÄÔ∏è</button>
  </header>

  <!-- Quick prefs -->
  <div class="row">
    <input id="userName" class="chip" placeholder="Your name"/>
    <select id="currency" class="chip">
      <option>‚Ç¨ EUR</option><option>$ USD</option><option>¬£ GBP</option><option>SAR</option>
    </select>
    <select id="accent" class="chip"><option>Blue</option><option>Sage</option><option>Sand</option></select>
    <button id="btnGoogle" class="chip" style="background:#f5c26b;color:#3a2a00">Sign in with Google</button>
    <button id="btnNotify" class="chip">Enable Notifications üîî</button>
    <button id="btnLogout" class="chip ghost" style="display:none">Logout</button>
  </div>

  <!-- Nav -->
  <nav id="tabs">
    <button data-tab="dash" class="active">Dashboard</button>
    <button data-tab="budget">Budget</button>
    <button data-tab="expense">Expenses</button>
    <button data-tab="savings">Savings</button>
    <button data-tab="payments">Payments</button>
    <button data-tab="commit">Commitments</button>
    <button data-tab="analysis">Analysis</button>
    <button data-tab="events">Events</button>
    <button data-tab="notes">Notes</button>
  </nav>

  <!-- ===== DASHBOARD ===== -->
  <section id="tab-dash" class="grid grid-2">
    <div class="card">
      <div class="h2" id="welcome">Welcome, Guest üëã</div>
      <blockquote>‚ÄúTrack your money. Master your life.‚Äù</blockquote>

      <div class="grid grid-3" style="margin-top:10px">
        <div class="card kpi"><div class="muted small">Current Balance</div><div class="big" id="kpi-balance">‚Ç¨ 0.00</div></div>
        <div class="card kpi"><div class="muted small">Total Expenses (month)</div><div class="big" id="kpi-exp">‚Ç¨ 0.00</div></div>
        <div class="card kpi">
          <div class="row"><div class="muted small">% Commitments Paid</div><div class="right small" id="kpi-paid-count">0/0</div></div>
          <div class="progress"><i id="kpi-paid"></i></div>
        </div>
      </div>

      <!-- Smart Insights -->
      <div class="grid" style="margin-top:10px">
        <div class="insight" id="insights">
          <div class="small muted">Smart Insights</div>
          <ul class="small" id="insights-list" style="margin:6px 0 0 18px"></ul>
        </div>
      </div>

      <!-- Upcoming -->
      <div class="card" style="margin-top:10px">
        <div class="row"><b>Next Due</b><div class="right muted small" id="kpi-next-due">‚Äî</div></div>
        <div class="row"><b>Next Event</b><div class="right muted small" id="kpi-next-event">‚Äî</div></div>
      </div>
    </div>

    <!-- Snapshot + mini charts -->
    <div class="card">
      <div class="h2">This Month Snapshot</div>
      <div class="row">
        <span class="badge">Top categories: <b id="dash-top3">‚Äî</b></span>
        <span class="badge">Daily avg: <b id="dash-daily">‚Äî</b></span>
      </div>
      <div class="sep"></div>
      <div class="small muted">Recent expenses</div>
      <ul id="dash-recent" class="clean small muted"></ul>
      <div class="sep"></div>
      <div class="grid grid-2">
        <div>
          <div class="small muted">Commitments status</div>
          <canvas id="miniCommit" class="mini"></canvas>
        </div>
        <div>
          <div class="small muted">Savings progress</div>
          <canvas id="miniSavings" class="mini"></canvas>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== BUDGET ===== -->
  <section id="tab-budget" class="grid">
    <div class="card">
      <div class="h2">Monthly Budget</div>
      <div class="row">
        <input id="b_item" placeholder="Item (e.g. Salary / Rent)"/>
        <select id="b_type"><option value="income">Income</option><option value="fixed">Fixed</option><option value="variable">Variable</option></select>
        <input id="b_amt" type="number" step="0.01" placeholder="Amount"/>
        <button id="btnAddB">+ Add</button>
      </div>
    </div>
    <div class="card">
      <div class="row"><div class="h2" style="margin:0">Items</div><div class="right muted">Totals: <span id="b_totals">‚Äî</span></div></div>
      <table id="b_table"><thead><tr><th>Item</th><th>Type</th><th>Amount</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <!-- ===== EXPENSES ===== -->
  <section id="tab-expense" class="grid">
    <div class="card">
      <div class="h2">Expenses</div>
      <div class="row">
        <input id="e_date" type="date" style="width:160px">
        <select id="e_cat" style="width:250px"></select>
        <input id="e_desc" placeholder="Description" style="flex:1">
        <input id="e_amt" type="number" step="0.01" placeholder="Amount" style="width:160px">
        <select id="e_method" style="width:140px"><option>Card</option><option>Cash</option><option>Transfer</option><option>Other</option></select>
        <button id="btnAddE">+ Add</button>
      </div>
    </div>
    <div class="card">
      <div class="row"><div class="h2" style="margin:0">History</div><div class="right muted">Total: <span id="e_total">0.00</span></div></div>
      <table id="e_table"><thead><tr><th>Date</th><th>Category</th><th>Description</th><th>Amount</th><th>Method</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <!-- ===== SAVINGS ===== -->
  <section id="tab-savings" class="grid">
    <div class="card">
      <div class="h2">Saving Plans</div>
      <div class="row">
        <input id="s_name" placeholder="Goal name (Vacation‚Ä¶)" style="flex:2">
        <select id="s_cat"><option>Vacation</option><option>Wedding</option><option>Investment</option><option>Other</option></select>
        <input id="s_target" type="number" step="0.01" placeholder="Target">
        <input id="s_months" type="number" step="1" placeholder="Months">
      </div>
      <div class="row" style="margin-top:8px">
        <input id="s_start" type="date">
        <input id="s_end" type="date" readonly>
        <label class="chip"><input type="checkbox" id="s_toCommit" style="margin-right:8px" checked>Add to Commitments</label>
        <button id="btnAddS">+ Add Plan</button>
      </div>
    </div>
    <div class="card">
      <div class="row"><div class="h2" style="margin:0">Plans</div><div class="right muted">Total progress: <span id="s_total_prog">0%</span></div></div>
      <table id="s_table"><thead><tr><th>Goal</th><th>Category</th><th>Target</th><th>Months</th><th>Monthly</th><th>Start</th><th>End</th><th>Progress</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <!-- ===== PAYMENTS ===== -->
  <section id="tab-payments" class="grid">
    <div class="card">
      <div class="h2">Payments</div>
      <div class="row">
        <select id="p_type"><option>Commitment</option><option>Expense</option><option>Saving</option></select>
        <input id="p_ref" placeholder="Reference (e.g. Rent June)">
        <input id="p_amt" type="number" step="0.01" placeholder="Amount">
        <input id="p_date" type="date">
        <datalist id="goals"></datalist>
        <button id="btnAddP">+ Log Payment</button>
      </div>
      <div class="small muted">Tip: for Saving payments, set <i>Reference</i> exactly to the goal name to auto-increase its saved amount.</div>
    </div>
    <div class="card">
      <div class="row"><div class="h2" style="margin:0">History</div></div>
      <table id="p_table"><thead><tr><th>Date</th><th>Type</th><th>Reference</th><th>Amount</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <!-- ===== COMMITMENTS ===== -->
  <section id="tab-commit" class="grid">
    <div class="card">
      <div class="h2">Commitments (Fixed)</div>
      <div class="row">
        <input id="c_name" placeholder="Commitment name" style="flex:2">
        <select id="c_cat" style="width:260px"></select>
        <input id="c_amount" type="number" step="0.01" placeholder="Monthly">
        <input id="c_due" type="date">
        <button id="btnAddC">+ Add</button>
      </div>
      <div class="row" style="margin-top:8px">
        <label class="chip"><input type="checkbox" id="c_remind" checked style="margin-right:8px">Auto-remind</label>
        <select id="c_remindWhen" class="chip"><option value="30">30 days</option><option value="7">7 days</option><option value="3">3 days</option><option value="1">1 day</option></select>
      </div>
    </div>
    <div class="card">
      <div class="row"><div class="h2" style="margin:0">List</div><div class="right muted">Total: <span id="c_total">0.00</span></div></div>
      <table id="c_table"><thead><tr><th>Name</th><th>Category</th><th>Monthly</th><th>Due</th><th>Status</th><th>Reminder</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <!-- ===== ANALYSIS ===== -->
  <section id="tab-analysis" class="grid">
    <div class="card">
      <div class="h2">Spending Analysis (Charts)</div>
      <div class="grid grid-2">
        <div><div class="small muted">By Category (Pie)</div><canvas id="chPie"></canvas></div>
        <div><div class="small muted">Monthly Trend (Bar - last 6)</div><canvas id="chBar"></canvas></div>
      </div>
      <div class="grid grid-2" style="margin-top:12px">
        <div><div class="small muted">Income vs Expenses (Line)</div><canvas id="chLine"></canvas></div>
        <div><div class="small muted">Commitments Status (Doughnut)</div><canvas id="chDoughnut"></canvas></div>
      </div>
      <div style="margin-top:12px">
        <div class="small muted">Spending Behavior (Radar)</div>
        <canvas id="chRadar"></canvas>
      </div>
    </div>

    <div class="card">
      <div class="h2" style="margin:0">Text Insights</div>
      <ul class="small" id="txtInsights"></ul>
      <div class="row" style="margin-top:8px">
        <button id="btnCompare" class="ghost">Compare to last month</button>
      </div>
    </div>
  </section>

  <!-- ===== EVENTS (ÿ£Ÿèÿ∂ŸäŸÅ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ) ===== -->
  <section id="tab-events" class="grid">
    <div class="card">
      <div class="h2">Events & Gifts</div>
      <div class="row">
        <input id="ev_name" placeholder="Event (e.g. Mom's Birthday)" style="flex:2">
        <select id="ev_type">
          <option>Birthday</option><option>Anniversary</option>
          <option>Holiday</option><option>Gift</option><option>Other</option>
        </select>
        <input id="ev_date" type="date">
        <input id="ev_amt" type="number" step="0.01" placeholder="Planned spend">
      </div>
      <div class="row" style="margin-top:8px">
        <label class="chip"><input type="checkbox" id="ev_toCommit" style="margin-right:8px">Add to Commitments</label>
        <textarea id="ev_notes" placeholder="Notes‚Ä¶" style="flex:1"></textarea>
        <button id="btnAddEV">+ Add Event</button>
      </div>
    </div>
    <div class="card">
      <div class="row">
        <div class="h2" style="margin:0">Planner</div>
        <div class="right muted">Next in: <span id="ev_next">‚Äî</span> | Gifts budget: <span id="ev_gifts">0.00</span></div>
      </div>
      <table id="ev_table">
        <thead>
          <tr><th>Event</th><th>Type</th><th>Date</th><th>Planned</th><th>Reminder</th><th>Notes</th><th></th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- ===== NOTES ===== -->
  <section id="tab-notes" class="grid">
    <div class="card">
      <div class="h2">Notes & Motivation</div>
      <blockquote>‚ÄúTrack your money. Reach your goals.‚Äù</blockquote>
      <textarea id="notes" placeholder="Write your financial goals, plans, and notes here‚Ä¶"></textarea>
      <div class="row" style="margin-top:8px"><button id="btnSaveNotes">Save Notes</button><span class="muted small">Saved to your account.</span></div>
    </div>
  </section>

</div>

<!-- OneSignal SDK -->
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

<!-- Firebase (modular v10) + App logic -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ===== Firebase config ===== */
const firebaseConfig = {
  apiKey: "AIzaSyCfnCTuunR_E15GQaPQyUbS2Fdj6XAYfUo",
  authDomain: "smart-budget-61664.firebaseapp.com",
  projectId: "smart-budget-61664",
  storageBucket: "smart-budget-61664.appspot.com",
  messagingSenderId: "273780649075",
  appId: "1:273780649075:web:c0c08d6d56f5085e9e06"
};

const appFB = initializeApp(firebaseConfig);
const auth = getAuth(appFB);
const db = getFirestore(appFB);
const provider = new GoogleAuthProvider();

/* ===== OneSignal ===== */
window.OneSignalDeferred = window.OneSignalDeferred || [];
OneSignalDeferred.push(async function(OneSignal) {
  await OneSignal.init({ appId: "5dbef29c-1d7a-403d-9399-b2566983cc30", allowLocalhostAsSecureOrigin: true });
});

/* ===== Helpers/UI ===== */
const $ = s => document.querySelector(s);
const byId = id => document.getElementById(id);
const setText = (id,t)=>{ const el=byId(id); if(el) el.textContent = t; };
const fmt = (v)=> (byId('currency').value.split(' ')[0] || '‚Ç¨') + ' ' + Number(v||0).toFixed(2);
const todayISO = ()=> new Date().toISOString().slice(0,10);
const monthKey = d => (d.slice ? d.slice(0,7) : new Date(d).toISOString().slice(0,7)); // YYYY-MM

/* ===== Theme toggle ===== */
const btnTheme = byId('btn-theme');
const savedTheme = localStorage.getItem('sb_theme') || 'light';
if(savedTheme==='dark') document.documentElement.setAttribute('data-theme','dark');
btnTheme.onclick = ()=>{
  const dark = document.documentElement.getAttribute('data-theme')==='dark';
  document.documentElement.setAttribute('data-theme', dark?'':'dark');
  localStorage.setItem('sb_theme', dark?'light':'dark');
};

/* ===== Tabs ===== */
document.querySelectorAll('nav button').forEach(b=>{
  b.onclick = ()=>{
    document.querySelectorAll('nav button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    document.querySelectorAll('section[id^="tab-"]').forEach(sec=>sec.style.display='none');
    byId('tab-'+b.dataset.tab).style.display = 'grid';
    if(b.dataset.tab==='analysis'){ buildCharts(); fillTextInsights(); }
  };
});

/* ===== Categories ===== */
const FULL_CATEGORIES = [
  "Groceries","Coffee & Snacks","Dining Out","Household Supplies","Fuel / Gas","Public Transport","Car Maintenance",
  "Rent / Mortgage","Electricity","Water","Internet & Phone","Home Maintenance","Healthcare / Medicine","Insurance",
  "Gym / Fitness","Personal Care","Clothing & Accessories","Gifts & Celebrations","Entertainment","Hobbies & Subscriptions",
  "Courses & Learning","Books & Materials","Work Expenses","Software & Apps","Savings / Investments",
  "Travel","Accommodation","Activities & Tickets","Donations & Charity","Taxes & Fees","Miscellaneous"
];
function fillSelect(sel, items){ sel.innerHTML = items.map(x=>`<option>${x}</option>`).join(''); }
fillSelect(byId('e_cat'), FULL_CATEGORIES);
fillSelect(byId('c_cat'), FULL_CATEGORIES);

/* ===== Inputs & buttons ===== */
const nameEl=byId('userName'), currencyEl=byId('currency'), accentEl=byId('accent');
const btnGoogle=byId('btnGoogle'), btnLogout=byId('btnLogout'), btnNotify=byId('btnNotify');

/* ===== Local prefs ===== */
nameEl.value = localStorage.getItem('sb_name') || '';
currencyEl.value = localStorage.getItem('sb_cur') || '‚Ç¨ EUR';
accentEl.value = localStorage.getItem('sb_accent') || 'Blue';
[nameEl,currencyEl,accentEl].forEach(el=> el.onchange = ()=> {
  localStorage.setItem('sb_name', nameEl.value);
  localStorage.setItem('sb_cur', currencyEl.value);
  localStorage.setItem('sb_accent', accentEl.value);
  renderAll();
  if(uid) savePrefs();
});

/* ===== SW + Notifications ===== */
if('serviceWorker' in navigator){ navigator.serviceWorker.register('/sw.js'); }
btnNotify.onclick = async ()=>{ try{
  const perm = await Notification.requestPermission();
  if(perm!=='granted') alert('Notifications are blocked.');
}catch(e){ console.error(e); }};

/* ===== Auth ===== */
btnGoogle.onclick = async ()=>{ try{ await signInWithPopup(auth, provider); }catch(e){ alert('Google sign-in blocked (pop-ups?).'); console.error(e);} };
btnLogout.onclick = ()=> signOut(auth);

/* ===== Firestore state ===== */
let uid=null, userDocRef=null, userData=null;
async function savePrefs(){ await updateDoc(userDocRef, { prefs:{ name:nameEl.value, currency:currencyEl.value, accent:accentEl.value } }); }

/* ===== Helpers ===== */
function daysUntil(dateISO){ return Math.ceil((new Date(dateISO).getTime()-Date.now())/86400000); }
function statusFromDue(dueISO, status){
  if(status==='Paid') return 'Paid';
  if(!dueISO) return 'Pending';
  const d=daysUntil(dueISO);
  if(d<0) return 'Overdue';
  if(d<=3) return 'Due soon';
  return 'Pending';
}
function pillClass(s){ return s==='Paid'?'paid': s==='Overdue'?'over': s==='Due soon'?'soon':'pend'; }
function scheduleLocalReminder(payload){
  const delay = Math.max(0, payload.fireAt - Date.now());
  setTimeout(()=>{ if(Notification.permission==='granted'){ new Notification(payload.title, { body: payload.body, icon:'/icon-192.png' }); } }, delay);
  if(navigator.serviceWorker.controller){ navigator.serviceWorker.controller.postMessage({type:'schedule', payload}); }
}

/* ===== Renderers ===== */
function renderKPIs(){
  const name = nameEl.value || 'Guest';
  setText('welcome', `Welcome, ${name} üëã`);

  const exps = userData?.expenses || [];
  const cmt  = userData?.commitments || [];
  const bud  = userData?.budget || [];
  const savs = userData?.savings || [];

  const income = bud.filter(x=>x.type==='income').reduce((a,x)=>a+Number(x.amount||0),0);
  const fixed  = bud.filter(x=>x.type!=='income').reduce((a,x)=>a+Number(x.amount||0),0);
  const expTot = exps.filter(e=> monthKey(e.date)===monthKey(todayISO()))
                     .reduce((a,x)=>a+Number(x.amount||0),0);
  setText('kpi-balance', fmt(income - (expTot + fixed)));
  setText('kpi-exp', fmt(expTot));

  const paid = cmt.filter(x=>x.status==='Paid').length;
  setText('kpi-paid-count', `${paid}/${cmt.length}`);
  byId('kpi-paid').style.width = (cmt.length? Math.round(paid*100/cmt.length):0)+'%';

  const upcoming = cmt.filter(x=>x.status!=='Paid' && x.due).map(x=>({name:x.name,days:daysUntil(x.due)})).sort((a,b)=>a.days-b.days)[0];
  setText('kpi-next-due', upcoming? `${upcoming.days} day(s) ‚Äî ${upcoming.name}` : '‚Äî');

  const evs = userData?.events || [];
  const now = new Date();
  const nextEv = evs.map(x=>({name:x.eventName,date:new Date(x.eventDate)})).filter(x=>x.date>=now).map(x=>({name:x.name,days:Math.ceil((x.date-now)/86400000)})).sort((a,b)=>a.days-b.days)[0];
  setText('kpi-next-event', nextEv? `${nextEv.days} day(s) ‚Äî ${nextEv.name}` : '‚Äî');

  const perCat = {};
  exps.forEach(e=> { const mOk = monthKey(e.date)===monthKey(todayISO()); if(mOk) perCat[e.category]=(perCat[e.category]||0)+Number(e.amount||0); });
  const top = Object.entries(perCat).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([k])=>k).join(', ') || '‚Äî';
  setText('dash-top3', top);
  const monthDays = new Date().getDate();
  setText('dash-daily', fmt((expTot||0)/monthDays));
  byId('dash-recent').innerHTML = (userData?.expenses||[]).slice(-6).reverse().map(e=>`<li>${e.date} ‚Äî ${e.category}: ${fmt(e.amount)} (${e.method})</li>`).join('');

  fillSmartInsights();
}

/* Smart Insights (Dashboard) */
function fillSmartInsights(){
  const list = byId('insights-list'); list.innerHTML='';
  const exps = userData?.expenses || [];
  const nowKey = monthKey(todayISO());
  const lastKey = (()=>{ const d=new Date(); d.setMonth(d.getMonth()-1); return d.toISOString().slice(0,7); })();
  const sumByMonth = (k)=> exps.filter(e=>monthKey(e.date)===k).reduce((a,x)=>a+Number(x.amount||0),0);
  const thisM = sumByMonth(nowKey);
  const lastM = sumByMonth(lastKey);
  const diffPct = lastM? Math.round((thisM-lastM)/lastM*100): (thisM?100:0);
  const topCat = (()=>{ const m={}; exps.filter(e=>monthKey(e.date)===nowKey).forEach(e=>m[e.category]=(m[e.category]||0)+Number(e.amount||0)); const s=Object.entries(m).sort((a,b)=>b[1]-a[1])[0]; return s? s[0]:'‚Äî'; })();
  const day = new Date().getDate();
  const avgDay = thisM / Math.max(1, day);
  const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth()+1, 0).getDate();
  const forecast = avgDay * daysInMonth;

  const li = t => { const el=document.createElement('li'); el.textContent=t; return el; };
  if(lastM>0) list.appendChild(li(`You spent ${Math.abs(diffPct)}% ${diffPct>=0?'more':'less'} than last month.`));
  else list.appendChild(li(`Spending started this month. Keep tracking!`));
  list.appendChild(li(`Most of your spending is in: ${topCat}.`));
  list.appendChild(li(`Projected month-end expenses ‚âà ${fmt(forecast)}.`));
}

/* Mini charts on Dashboard */
let miniCommitChart, miniSavingsChart;
function buildMiniCharts(){
  const cs = userData?.commitments||[];
  const statusCount = {Paid:0,'Due soon':0,Overdue:0,Pending:0};
  cs.forEach(c=> statusCount[statusFromDue(c.due,c.status)]++);
  const ctx1 = byId('miniCommit').getContext('2d');
  if(miniCommitChart) miniCommitChart.destroy();
  miniCommitChart = new Chart(ctx1,{ type:'doughnut',
    data:{ labels:Object.keys(statusCount), datasets:[{ data:Object.values(statusCount) }] },
    options:{ plugins:{legend:{display:false}}, cutout:'60%' }
  });

  const ss = userData?.savings||[];
  let avg=0;
  if(ss.length){
    const totalTarget = ss.reduce((a,x)=>a+Number(x.target||0),0);
    const totalSaved  = ss.reduce((a,x)=>a+Number(x.saved||0),0);
    avg = totalTarget? Math.round(totalSaved*100/totalTarget):0;
  }
  const ctx2 = byId('miniSavings').getContext('2d');
  if(miniSavingsChart) miniSavingsChart.destroy();
  miniSavingsChart = new Chart(ctx2,{ type:'doughnut',
    data:{ labels:['Progress','Remaining'], datasets:[{ data:[avg, 100-avg] }] },
    options:{ plugins:{legend:{display:false}}, cutout:'60%' }
  });
}

/* ===== Tables ===== */
function redrawBudget(){
  const tbody = byId('b_table').querySelector('tbody'); const items = userData?.budget||[];
  tbody.innerHTML = items.map(x=>`<tr><td>${x.item}</td><td>${x.type}</td><td>${fmt(x.amount)}</td><td><button class="ghost" data-bid="${x.id}">Delete</button></td></tr>`).join('');
  tbody.querySelectorAll('button[data-bid]').forEach(b=> b.onclick = ()=> delRow('budget', b.dataset.bid));
  const inc=items.filter(i=>i.type==='income').reduce((a,x)=>a+Number(x.amount||0),0);
  const fix=items.filter(i=>i.type==='fixed').reduce((a,x)=>a+Number(x.amount||0),0);
  const varb=items.filter(i=>i.type==='variable').reduce((a,x)=>a+Number(x.amount||0),0);
  setText('b_totals', `Income ${fmt(inc)} ‚Ä¢ Fixed ${fmt(fix)} ‚Ä¢ Variable ${fmt(varb)}`);
}
function redrawExpenses(){
  const tbody = byId('e_table').querySelector('tbody'); const exps = userData?.expenses||[];
  tbody.innerHTML = exps.slice().reverse().map(e=>`<tr>
    <td>${e.date}</td><td>${e.category}</td><td>${e.description||''}</td>
    <td>${fmt(e.amount)}</td><td>${e.method}</td>
    <td><button class="ghost" data-id="${e.id}" data-type="expense">Delete</button></td>
  </tr>`).join('');
  tbody.querySelectorAll('button[data-type="expense"]').forEach(b=> b.onclick=()=>delRow('expenses', b.dataset.id));
  setText('e_total', exps.reduce((a,x)=>a+Number(x.amount||0),0).toFixed(2));
}
function redrawCommitments(){
  const tbody = byId('c_table').querySelector('tbody'); const cs = userData?.commitments||[];
  tbody.innerHTML = cs.map(c=>{
    const s = statusFromDue(c.due,c.status);
    return `<tr>
      <td>${c.name}</td><td>${c.category}</td><td>${fmt(c.amount)}</td><td>${c.due||''}</td>
      <td><span class="pill ${pillClass(s)}">${s}</span></td>
      <td>${c.remind?`üîî ${c.remindDays}d before`:''}</td>
      <td>
        <button class="ghost" data-act="paid" data-id="${c.id}">Mark paid</button>
        <button class="ghost" data-act="del" data-id="${c.id}">Delete</button>
      </td>
    </tr>`;
  }).join('');
  tbody.querySelectorAll('button').forEach(b=> b.onclick=()=> rowActionCommit(b.dataset.act,b.dataset.id));
  setText('c_total', (userData?.commitments||[]).reduce((a,x)=>a+Number(x.amount||0),0).toFixed(2));
}
function redrawSavings(){
  const tbody = byId('s_table').querySelector('tbody'); const ss = userData?.savings||[];
  tbody.innerHTML = ss.map(s=>{
    const prog = Math.min(Math.round((s.saved||0)*100/Number(s.target||1)),100);
    return `<tr>
      <td>${s.name}</td><td>${s.category}</td><td>${fmt(s.target)}</td>
      <td>${s.months}</td><td>${fmt(s.monthly)}</td><td>${s.start}</td><td>${s.end}</td>
      <td><div class="progress"><i style="width:${prog}%"></i></div><div class="small muted">${prog}%</div></td>
      <td><button class="ghost" data-id="${s.id}">Delete</button></td>
    </tr>`;
  }).join('');
  tbody.querySelectorAll('button').forEach(b=> b.onclick = ()=> delRow('savings', b.dataset.id));
  const totalProg = ss.length? Math.round((ss.reduce((a,x)=>a+(x.saved||0),0)/ss.reduce((a,x)=>a+Number(x.target||0),0))*100):0;
  setText('s_total_prog', (isFinite(totalProg)?totalProg:0)+'%');
}
function redrawPayments(){
  const tbody = byId('p_table').querySelector('tbody'); const ps = userData?.payments||[];
  tbody.innerHTML = ps.slice().reverse().map(p=>`<tr>
    <td>${p.date}</td><td>${p.type}</td><td>${p.ref}</td><td>${fmt(p.amount)}</td>
    <td><button class="ghost" data-id="${p.id}">Delete</button></td>
  </tr>`).join('');
  tbody.querySelectorAll('button').forEach(b=> b.onclick=()=> delRow('payments', b.dataset.id));
}
function redrawEvents(){
  const tbody = byId('ev_table').querySelector('tbody'); const evs = userData?.events||[];
  let giftsTotal=0, nextDays=null;
  tbody.innerHTML = evs.map(e=>{
    giftsTotal += Number(e.planned||0);
    const diff = Math.ceil((new Date(e.eventDate)-Date.now())/86400000);
    if(diff>=0 && (nextDays===null || diff<nextDays)) nextDays=diff;
    let cls='pend', txt='‚Äî'; 
    if(diff<0){ cls=''; txt='‚ö™ Past'; }
    else if(diff<=3){ cls='over'; txt='üî¥ 3 days'; }
    else if(diff<=7){ cls='soon'; txt='üü† 1 week'; }
    else if(diff<=30){ cls='pend'; txt='üíô 1 month'; }
    else { cls='pend'; txt=diff+' days'; }
    return `<tr>
      <td>${e.eventName}</td><td>${e.eventType}</td><td>${e.eventDate}</td><td>${fmt(e.planned||0)}</td>
      <td><span class="pill ${cls}">${txt}</span></td><td>${e.notes||''}</td>
      <td><button class="ghost" data-id="${e.id}">Delete</button></td>
    </tr>`;
  }).join('');
  tbody.querySelectorAll('button').forEach(b=> b.onclick=()=> delRow('events', b.dataset.id));
  setText('ev_gifts', (giftsTotal||0).toFixed(2));
  setText('ev_next', nextDays===null?'‚Äî':`${nextDays} day(s)`);
}

/* ===== Text Insights (Analysis) + Compare toggle ===== */
let compareMode = false;
const btnCompareEl = byId('btnCompare');
if (btnCompareEl) {
  btnCompareEl.onclick = () => {
    compareMode = !compareMode;
    btnCompareEl.textContent = compareMode ? 'Show current month' : 'Compare to last month';
    buildCharts();
    fillTextInsights();
  };
}
function fillTextInsights(){
  const el = byId('txtInsights'); el.innerHTML='';
  if (compareMode) { el.insertAdjacentHTML('beforeend','<li>Comparison mode: showing current vs last month.</li>'); }
  const exps = userData?.expenses || [];
  if(!exps.length){ el.innerHTML+='<li>No data yet. Add some expenses to see insights.</li>'; return; }
  const groupBy = (arr, f)=> arr.reduce((m,x)=>{ const k=f(x); m[k]=(m[k]||0)+Number(x.amount||0); return m; },{});
  const byMonth = groupBy(exps, e=>monthKey(e.date));
  const months = Object.keys(byMonth).sort();
  const topMonth = months.sort((a,b)=>byMonth[b]-byMonth[a])[0];

  const sav = (userData?.savings||[]).reduce((a,x)=>a+Number(x.saved||0),0);
  const income = (userData?.budget||[]).filter(x=>x.type==='income').reduce((a,x)=>a+Number(x.amount||0),0);
  const rate = income? Math.round(sav*100/income):0;

  const thisKey = monthKey(todayISO());
  const curExp = exps.filter(e=>monthKey(e.date)===thisKey).reduce((a,x)=>a+Number(x.amount||0),0);
  const ratio = income? Math.round(curExp*100/income):0;

  const catAgg = groupBy(exps, e=>e.category);
  const top3 = Object.entries(catAgg).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([k])=>k).join(', ');
  const least = Object.entries(catAgg).sort((a,b)=>a[1]-b[1])[0]?.[0] || '‚Äî';

  const li=t=>{ const x=document.createElement('li'); x.textContent=t; el.appendChild(x); };
  li(`Top 3 categories: ${top3}`);
  li(`Least used category: ${least}`);
  li(`Month with highest expenses: ${topMonth||'‚Äî'}`);
  li(`Average saving rate: ${rate}%`);
  li(`Expense to income ratio (current month): ${ratio}%`);
}

/* ===== Charts (Analysis) ===== */
let chPie, chBar, chLine, chDoughnut, chRadar;
function buildCharts(){
  const exps = userData?.expenses || [];
  const cmts = userData?.commitments || [];
  const bud  = userData?.budget || [];

  const thisKey = monthKey(todayISO());
  const lastKey = (()=>{ const d=new Date(); d.setMonth(d.getMonth()-1); return d.toISOString().slice(0,7); })();

  // Pie: by category (current vs last)
  const aggByCat = (key)=>{
    const m={}; exps.filter(e=>monthKey(e.date)===key).forEach(e=> m[e.category]=(m[e.category]||0)+Number(e.amount||0));
    return m;
  };
  const cur = aggByCat(thisKey);
  const prev= aggByCat(lastKey);
  const allCats = Array.from(new Set([...Object.keys(cur), ...Object.keys(prev)]));
  const curArr  = allCats.map(k=>cur[k]||0);
  const prevArr = allCats.map(k=>prev[k]||0);
  if(chPie) chPie.destroy();
  chPie = new Chart(byId('chPie'), {
    type:'pie',
    data:{
      labels: allCats,
      datasets: compareMode
        ? [{label:'This month', data:curArr},{label:'Last month', data:prevArr}]
        : [{label:'This month', data:curArr}]
    },
    options:{ plugins:{legend:{position:'bottom'}} }
  });

  // Bar: monthly trend last 6
  const trend = {};
  for(let i=5;i>=0;i--){
    const d=new Date(); d.setMonth(d.getMonth()-i);
    const k=d.toISOString().slice(0,7);
    trend[k]= exps.filter(e=>monthKey(e.date)===k).reduce((a,x)=>a+Number(x.amount||0),0);
  }
  if(chBar) chBar.destroy();
  chBar = new Chart(byId('chBar'), {
    type:'bar',
    data:{ labels:Object.keys(trend), datasets:[{ label:'Expenses', data:Object.values(trend) }] },
    options:{ plugins:{legend:{display:false}} }
  });

  // Line: income vs expenses (with compare)
  const income = bud.filter(x=>x.type==='income').reduce((a,x)=>a+Number(x.amount||0),0);
  const expCur = exps.filter(e=>monthKey(e.date)===thisKey).reduce((a,x)=>a+Number(x.amount||0),0);
  const expPrev= exps.filter(e=>monthKey(e.date)===lastKey).reduce((a,x)=>a+Number(x.amount||0),0);
  if(chLine) chLine.destroy();
  chLine = new Chart(byId('chLine'), {
    type:'line',
    data:{
      labels:['Income','Expenses'],
      datasets: compareMode
        ? [
            {label:'This month', data:[income, expCur]},
            {label:'Last month',  data:[income, expPrev]}
          ]
        : [{label:'This month', data:[income, expCur]}]
    },
    options:{ plugins:{legend:{position:'bottom'}}, scales:{ y:{ beginAtZero:true } } }
  });

  // Doughnut: commitments status
  const statusCount = {Paid:0,'Due soon':0,Overdue:0,Pending:0};
  cmts.forEach(c=> statusCount[statusFromDue(c.due,c.status)]++);
  if(chDoughnut) chDoughnut.destroy();
  chDoughnut = new Chart(byId('chDoughnut'), {
    type:'doughnut',
    data:{ labels:Object.keys(statusCount), datasets:[{ data:Object.values(statusCount) }] },
    options:{ plugins:{legend:{position:'bottom'}}, cutout:'55%' }
  });

  // Radar: behavior buckets
  const buckets = { Food:0, Transport:0, Living:0, Lifestyle:0, Other:0 };
  exps.forEach(e=>{
    const c=e.category, v=Number(e.amount||0);
    if(['Groceries','Coffee & Snacks','Dining Out'].includes(c)) buckets.Food+=v;
    else if(['Fuel / Gas','Public Transport','Car Maintenance'].includes(c)) buckets.Transport+=v;
    else if(['Rent / Mortgage','Electricity','Water','Internet & Phone','Home Maintenance'].includes(c)) buckets.Living+=v;
    else if(['Entertainment','Hobbies & Subscriptions','Gym / Fitness','Personal Care','Clothing & Accessories'].includes(c)) buckets.Lifestyle+=v;
    else buckets.Other+=v;
  });
  if(chRadar) chRadar.destroy();
  chRadar = new Chart(byId('chRadar'), { type:'radar',
    data:{ labels:Object.keys(buckets), datasets:[{ label:'Spending', data:Object.values(buckets) }] },
    options:{ plugins:{legend:{display:false}} }
  });

  buildMiniCharts();
}

/* ===== Glue render ===== */
function renderAll(){ renderKPIs(); redrawBudget(); redrawExpenses(); redrawCommitments(); redrawSavings(); redrawPayments(); redrawEvents(); buildMiniCharts(); }

/* ===== Add handlers ===== */
byId('btnAddB').onclick = async ()=>{
  if(!uid) return alert('Sign in first.');
  const item = { id:crypto.randomUUID(), item:byId('b_item').value, type:byId('b_type').value, amount:Number(byId('b_amt').value||0) };
  if(!item.item || !item.amount) return alert('Enter item & amount');
  await updateArray('budget', item);
  byId('b_item').value=''; byId('b_amt').value='';
};
byId('btnAddE').onclick = async ()=>{
  if(!uid) return alert('Sign in first.');
  const it = { id:crypto.randomUUID(), date:byId('e_date').value||todayISO(), category:byId('e_cat').value, description:byId('e_desc').value||'', amount:Number(byId('e_amt').value||0), method:byId('e_method').value };
  if(!it.amount) return alert('Amount?');
  await updateArray('expenses', it); byId('e_desc').value=''; byId('e_amt').value='';
};
byId('btnAddC').onclick = async ()=>{
  if(!uid) return alert('Sign in first.');
  const it = { id:crypto.randomUUID(), name:byId('c_name').value, category:byId('c_cat').value, amount:Number(byId('c_amount').value||0), due:byId('c_due').value, status:"Pending", remind:byId('c_remind').checked, remindDays:Number(byId('c_remindWhen').value) };
  if(!it.name || !it.amount || !it.due) return alert('Enter name, amount, due');
  await updateArray('commitments', it);
  if(it.remind){
    const when = new Date(it.due); when.setDate(when.getDate()-it.remindDays);
    scheduleLocalReminder({ id:it.id, title:'Commitment Reminder', body:`${it.name} due ${it.due} (${fmt(it.amount)})`, fireAt:when.getTime() });
  }
  byId('c_name').value=''; byId('c_amount').value=''; byId('c_due').value='';
};
byId('btnAddS').onclick = async ()=>{
  if(!uid) return alert('Sign in first.');
  const name=byId('s_name').value, cat=byId('s_cat').value, target=Number(byId('s_target').value||0), months=Number(byId('s_months').value||0);
  if(!name||!target||!months) return alert('Fill goal, target, months');
  const start=byId('s_start').value||todayISO(); const end = (d=>{d.setMonth(d.getMonth()+months);return d.toISOString().slice(0,10)})(new Date(start));
  byId('s_end').value=end;
  const monthly = target/months;
  const it = { id:crypto.randomUUID(), name, category:cat, target, months, monthly, start, end, saved:0, autoDebit:true, lastAutoMonth:null };
  await updateArray('savings', it);
  if(byId('s_toCommit').checked){
    await updateArray('commitments', { id:crypto.randomUUID(), name:`Saving ‚Äì ${name}`, category:'Savings / Investments', amount:monthly, due:start, status:'Pending', remind:true, remindDays:7 });
  }
  byId('s_name').value=''; byId('s_target').value=''; byId('s_months').value='';
};
byId('btnAddP').onclick = async ()=>{
  if(!uid) return alert('Sign in first.');
  const it = { id:crypto.randomUUID(), type:byId('p_type').value, ref:byId('p_ref').value, amount:Number(byId('p_amt').value||0), date:byId('p_date').value||todayISO() };
  if(!it.amount || !it.ref) return alert('Ref & amount required');
  if(it.type==='Saving'){
    const ss = (userData?.savings||[]);
    const idx = ss.findIndex(s=> (s.name||'').trim().toLowerCase() === (it.ref||'').trim().toLowerCase());
    if(idx>-1){
      const g = ss[idx];
      const remain = Math.max(0, Number(g.target)-Number(g.saved||0));
      const add = Math.min(remain, Number(it.amount));
      ss[idx] = {...g, saved: Number(g.saved||0)+add };
      await updateDoc(userDocRef, { savings: ss });
      if(add < it.amount) alert('Amount exceeds goal target; extra ignored.');
    }
  }
  await updateArray('payments', it); byId('p_ref').value=''; byId('p_amt').value='';
};
/* Events add */
byId('btnAddEV').onclick = async ()=>{
  if(!uid) return alert('Sign in first.');
  const name=byId('ev_name').value, type=byId('ev_type').value,
        date=byId('ev_date').value, planned=Number(byId('ev_amt').value||0),
        notes=byId('ev_notes').value||'';
  if(!name||!date) return alert('Event name & date required');

  const it = { id:crypto.randomUUID(), eventName:name, eventType:type, eventDate:date, planned, notes };
  await updateArray('events', it);

  if(byId('ev_toCommit').checked && planned>0){
    await updateArray('commitments', {
      id:crypto.randomUUID(), name:`Gift ‚Äì ${name}`, category:'Gifts & Celebrations',
      amount:planned, due:date, status:'Pending', remind:true, remindDays:7
    });
  }

  byId('ev_name').value=''; byId('ev_amt').value=''; byId('ev_notes').value='';
};

/* Row helpers */
async function rowActionCommit(act,id){
  if(act==='paid'){
    const list = (userData.commitments||[]).map(x=> x.id===id? {...x, status:'Paid'}:x );
    await updateDoc(userDocRef,{ commitments:list });
  } else if(act==='del'){ await delRow('commitments', id); }
}
async function delRow(collectionKey, id){
  const list = (userData[collectionKey]||[]).filter(x=>x.id!==id);
  await updateDoc(userDocRef, { [collectionKey]: list });
}
async function updateArray(key, item){
  const docSnap = await getDoc(userDocRef);
  if(!docSnap.exists()) await setDoc(userDocRef, { prefs:{ name:nameEl.value, currency:currencyEl.value, accent:accentEl.value } });
  await updateDoc(userDocRef, { [key]: arrayUnion(item) });
}

/* Auto calc end date for savings */
byId('s_start').addEventListener('change', ()=>{
  const months = Number(byId('s_months').value||0); if(!months) return;
  const s = new Date(byId('s_start').value); s.setMonth(s.getMonth()+months); byId('s_end').value = s.toISOString().slice(0,10);
});

/* Auto-debit for savings (monthly once) */
function ensureSavingsAutoDebit(){
  const ss = (userData?.savings||[]);
  const nowMK = monthKey(todayISO());
  let changed=false;
  ss.forEach(s=>{
    if(s.autoDebit && s.lastAutoMonth!==nowMK){
      const remain = Math.max(0, Number(s.target)-Number(s.saved||0));
      if(remain>0){
        const pay = Math.min(remain, Number(s.monthly||0));
        s.saved = Number(s.saved||0)+pay;
        s.lastAutoMonth = nowMK;
        changed=true;
        const payItem = { id:crypto.randomUUID(), type:'Saving', ref:s.name, amount:pay, date:todayISO() };
        updateArray('payments', payItem);
      }
    }
  });
  if(changed){ updateDoc(userDocRef, { savings: ss }); }
}

/* Auth listener */
onAuthStateChanged(auth, async (user)=>{
  if(user){
    uid = user.uid;
    btnGoogle.style.display='none'; btnLogout.style.display='';
    userDocRef = doc(db,'users',uid);
    const snap = await getDoc(userDocRef);
    if(!snap.exists()){
      await setDoc(userDocRef, { prefs:{ name:nameEl.value, currency:currencyEl.value, accent:accentEl.value }, budget:[], expenses:[], commitments:[], savings:[], payments:[], events:[], notes:'' });
    }
    onSnapshot(userDocRef,(s)=>{
      userData = s.data() || {};
      const p = userData.prefs||{};
      nameEl.value = p.name || nameEl.value; currencyEl.value = p.currency || currencyEl.value; accentEl.value = p.accent || accentEl.value;
      byId('notes').value = userData.notes || '';
      renderAll();
      ensureSavingsAutoDebit();
    });
  }else{
    uid=null; userData=null;
    btnGoogle.style.display=''; btnLogout.style.display='none';
    renderAll();
  }
});

/* Notes save */
byId('btnSaveNotes').onclick = async ()=>{
  if(!uid) return alert('Sign in first.');
  await updateDoc(userDocRef, { notes: byId('notes').value||'' });
  alert('Notes saved.');
};

/* Initial show */
document.querySelectorAll('section[id^="tab-"]').forEach((s,i)=> s.style.display = i? 'none':'grid');
renderAll();
</script>
</body>
</html>
